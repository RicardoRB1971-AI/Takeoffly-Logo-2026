name: Build macOS DMG

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install create-dmg
        run: npm install -g create-dmg

      - name: Find HTML and ICNS
        run: |
          HTML_FILE=$(git ls-files | grep -i '\.html$' | head -n 1)
          ICON_FILE=$(git ls-files | grep -i '\.icns$' | head -n 1)

          if [ -z "$HTML_FILE" ]; then
            echo "ERROR: No HTML file found"
            exit 1
          fi

          if [ -z "$ICON_FILE" ]; then
            echo "ERROR: No ICNS file found"
            exit 1
          fi

          echo "HTML_FILE=$HTML_FILE" >> $GITHUB_ENV
          echo "ICON_FILE=$ICON_FILE" >> $GITHUB_ENV

      - name: Create .app structure
        run: |
          mkdir -p TakeOffFly.app/Contents/{MacOS,Resources}

          cp "$HTML_FILE" TakeOffFly.app/Contents/Resources/index.html
          cp "$ICON_FILE" TakeOffFly.app/Contents/Resources/AppIcon.icns

          echo '<?xml version="1.0" encoding="UTF-8"?>' > TakeOffFly.app/Contents/Info.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> TakeOffFly.app/Contents/Info.plist
          echo '<plist version="1.0"><dict>' >> TakeOffFly.app/Contents/Info.plist
          echo '<key>CFBundleName</key><string>TakeOffFly</string>' >> TakeOffFly.app/Contents/Info.plist
          echo '<key>CFBundleIdentifier</key><string>com.takeofffly.app</string>' >> TakeOffFly.app/Contents/Info.plist
          echo '<key>CFBundleExecutable</key><string>TakeOffFly</string>' >> TakeOffFly.app/Contents/Info.plist
          echo '<key>CFBundlePackageType</key><string>APPL</string>' >> TakeOffFly.app/Contents/Info.plist
          echo '<key>CFBundleIconFile</key><string>AppIcon.icns</string>' >> TakeOffFly.app/Contents/Info.plist
          echo '</dict></plist>' >> TakeOffFly.app/Contents/Info.plist

          echo '#!/bin/bash' > TakeOffFly.app/Contents/MacOS/TakeOffFly
          echo 'DIR="$(cd "$(dirname "$0")/../Resources" && pwd)"' >> TakeOffFly.app/Contents/MacOS/TakeOffFly
          echo 'open "$DIR/index.html"' >> TakeOffFly.app/Contents/MacOS/TakeOffFly

          chmod +x TakeOffFly.app/Contents/MacOS/TakeOffFly

      - name: Create DMG
        run: |
          create-dmg \
            --volname "TakeOffFly Installer" \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 300 \
            TakeOffFly-Installer.dmg \
            TakeOffFly.app

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: TakeOffFly-DMG
          path: TakeOffFly-Installer.dmg
