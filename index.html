<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta name="author" content="Ricardo Rivera Blanco"/>
  <meta name="creator" content="Ricardo Rivera Blanco"/>
  <meta name="Copyright" content="© 2026 Ricardo Rivera Blanco. All Rights Reserved."/>
  <meta name="description" content="TakeOffFly v1.0 — Professional Project + Authentication Management System"/>
  <meta name="company" content="TakeOffFly (Puerto Rico)"/>
  <title>TakeOffFly v1.0 — Project + Authentication Sheet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { width: 100%; height: 100%; overflow: hidden; }
    body { 
      font-family: 'Inter', 'Plus Jakarta Sans', sans-serif; 
      width: 100%; height: 100vh; display: flex;
      background: #f0f4f8; margin: 0; padding: 0;
      flex-direction: row;
    }
    body:fullscreen { width: 100%; height: 100%; }
    body:-webkit-full-screen { width: 100%; height: 100%; }
    body:-moz-full-screen { width: 100%; height: 100%; }
    
    /* ANIMACIONES MODERNAS */
    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* SIDEBAR */
    #sidebar-main {
      width: 160px;
      background: linear-gradient(135deg, #1a1f3a 0%, #0f1419 100%);
      box-shadow: 4px 0 20px rgba(0,0,0,0.3);
      z-index: 40;
      display: flex;
      flex-direction: column;
      animation: slideInLeft 0.5s ease;
      overflow-y: auto;
    }
    
    /* MAIN CONTAINER */
    #main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slideDown 0.5s ease;
    }
    
    .status-light { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .status-red { background:#ef4444; box-shadow:0 0 8px #ef4444; }
    .status-green { background:#22c55e; box-shadow:0 0 8px #22c55e; animation: pulse 2s infinite; }
    .status-amber { background:#f59e0b; box-shadow:0 0 8px #f59e0b; animation: pulse 2s infinite; }
    
    .viewer-main { flex:1; overflow:auto; background: linear-gradient(135deg, #cbd5e1 0%, #e2e8f0 100%); position:relative; }
    #canvas-wrapper { position:relative; margin:20px auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15); background:#fff; display:inline-block; border-radius: 8px; }
    #annotation-canvas { position:absolute; top:0; left:0; cursor:crosshair; }
    .tab-content { display:none; height:100%; width:100%; }
    .tab-content.active { display:flex; flex-direction:column; animation: fadeIn 0.3s ease; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:100; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
    .modal.active { display:flex; }
    .badge { display:inline-block; border-radius:9999px; padding:4px 10px; font-size:10px; font-weight:700; }
    #hover-tooltip { position:absolute; pointer-events:none; background:#111827; color:#fff; border-radius:8px; padding:10px 12px; font-size:12px; line-height:1.4; border:1px solid rgba(255,255,255,.2); box-shadow: 0 12px 24px rgba(0,0,0,0.3); z-index:50; display:none; max-width:280px; }
    #prop-preset { white-space: normal; word-wrap: break-word; }
    
    footer a { color:#6366f1; font-weight: 600; }
    main { overflow-x: hidden; }
    
    /* HEADER */
    header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 1rem;
      overflow-x: auto;
      z-index: 30;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* TOOLBAR */
    #toolbar-editor {
      overflow-x: auto;
      background: linear-gradient(to bottom, #ffffff, #f8fafc);
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem;
      z-index: 20;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* SIDEBAR ITEMS */
    .sidebar-section {
      padding: 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-section-title {
      font-size: 10px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    
    .sidebar-item {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      color: #cbd5e1;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid transparent;
    }
    
    .sidebar-item:hover {
      background: rgba(99, 102, 241, 0.2);
      color: #e2e8f0;
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateX(4px);
    }
    
    .sidebar-item.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      border-color: #6366f1;
    }
    
    /* TRANSITIONS */
    button, input, select, textarea {
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      border-color: #6366f1 !important;
    }
    
    button:disabled, input:disabled, select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* COPYRIGHT & LEGAL NOTICE STYLES */
    .copyright-notice {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
      line-height: 1.6;
      padding: 8px 12px;
    }

    .warning-modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 2px solid #ef4444;
    }

    .warning-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .warning-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .warning-title {
      font-size: 24px;
      font-weight: 900;
      color: #7f1d1d;
    }

    .warning-body {
      font-size: 14px;
      line-height: 1.8;
      color: #374151;
      margin-bottom: 20px;
    }

    .legal-list {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      font-size: 13px;
      line-height: 1.7;
    }

    .legal-list li {
      margin-bottom: 10px;
      color: #7f1d1d;
    }

    .legal-list strong {
      color: #991b1b;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
  <!-- AUTH MODAL -->
  <div id="auth-modal" class="modal active">
    <div class="bg-white rounded-3xl p-8 w-[520px] shadow-2xl border border-slate-200">
      <div class="flex items-center gap-3 mb-4">
        <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-3 rounded-xl"><i data-lucide="shield-check" class="w-5 h-5"></i></div>
        <h3 class="text-2xl font-black text-slate-800">Access — TakeOffFly</h3>
      </div>
      <p class="text-sm text-slate-600 mb-6">Restricted access. Enter your <b>Email</b> and <b>Secret Key</b> to validate against the database.</p>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Email</label>
          <input id="auth-email" type="email" placeholder="youremail@domain.com" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl font-medium outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
        </div>
        <div>
          <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Secret Key</label>
          <input id="auth-secret" type="password" placeholder="••••••" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl font-medium outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
        </div>
        <div class="flex items-center justify-between">
          <div class="text-[12px] text-slate-500">Source: Validation (Remote)</div>
          <button id="btn-auth" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg transition"><i data-lucide="log-in" class="w-4 h-4"></i> Login</button>
        </div>
        <div id="auth-msg" class="text-sm mt-2 text-red-600 hidden"></div>
      </div>
      <div class="mt-6 text-[11px] text-slate-500 leading-relaxed">
        <p><b>Note:</b> The system will validate your device. If you exceed the allowed device limit, contact the administrator.</p>
      </div>
    </div>
  </div>

  <!-- COPYRIGHT & LEGAL WARNING MODAL -->
  <div id="copyright-warning-modal" class="modal">
    <div class="warning-modal-content">
      <div class="warning-header">
        <div class="warning-icon">
          <i data-lucide="alert-triangle" class="w-8 h-8"></i>
        </div>
        <div>
          <div class="warning-title">Legal Notice & Copyright</div>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Protected Software</div>
        </div>
      </div>

      <div class="warning-body">
        <strong style="color: #7f1d1d; font-size: 15px;">TakeOffFly v1.0</strong> — Professional Project & Authentication Management System
      </div>

      <div class="legal-list">
        <strong style="display: block; margin-bottom: 12px; color: #991b1b;">© 2026 Ricardo Rivera Blanco. All Rights Reserved.</strong>
        
        <p style="margin-bottom: 12px; color: #374151;"><strong>Developer & Copyright Holder:</strong> Ricardo Rivera Blanco</p>
        <p style="margin-bottom: 12px; color: #374151;"><strong>Company:</strong> TakeOffFly</p>
        <p style="margin-bottom: 12px; color: #374151;"><strong>Location:</strong> Puerto Rico</p>
        <p style="margin-bottom: 16px; color: #6b7280; font-size: 12px; font-style: italic;"><strong>Note:</strong> This software incorporates AI technology assistance in its development.</p>

        <h4 style="color: #991b1b; font-weight: 700; margin-bottom: 10px;">Legal Protections:</h4>
        <ul style="list-style: disc; margin-left: 20px;">
          <li><strong>Copyright Protection:</strong> This software is protected under international copyright laws (Berne Convention, DMCA, TRIPS Agreement).</li>
          <li><strong>Intellectual Property Rights:</strong> All code, algorithms, designs, and business logic are proprietary and exclusively owned by Ricardo Rivera Blanco.</li>
          <li><strong>Unauthorized Reproduction Prohibited:</strong> Copying, reproducing, or distributing this software without explicit written permission is strictly prohibited.</li>
          <li><strong>Modification Restriction:</strong> Altering, reverse engineering, decompiling, or modifying the code is expressly forbidden by law.</li>
          <li><strong>Legal Enforcement:</strong> Violators may face criminal prosecution, civil liability, and substantial monetary damages.</li>
          <li><strong>Licensing:</strong> Use of this software is permitted only under the terms of the provided license agreement.</li>
          <li><strong>AI Technology Disclosure:</strong> This software was developed with the assistance of AI technology. Despite AI assistance, all intellectual property and copyright rights remain exclusively with Ricardo Rivera Blanco.</li>
          <li><strong>No Warranty Disclaimer:</strong> This software is provided "as-is" without warranty. Users assume all responsibility for its use.</li>
        </ul>
      </div>

      <div style="text-align: center; padding-top: 16px; border-top: 1px solid #e5e7eb;">
        <button onclick="document.getElementById('copyright-warning-modal').classList.remove('active')" class="bg-red-600 hover:bg-red-700 text-white px-8 py-2 rounded-lg font-bold transition">
          I Understand & Accept
        </button>
      </div>
    </div>
  </div>

  <!-- SIDEBAR NAVEGACIÓN -->
  <aside id="sidebar-main" class="text-white flex-col hidden md:flex">
    <!-- Logo Section -->
    <div class="p-6 border-b border-white/10 flex items-center justify-center">
      <img id="app-logo" src="https://storage.googleapis.com/permisos-takeoff/takeoffly%20Logo.png" alt="Logo" style="height:40px;width:auto;" />
    </div>

    <!-- Navigation Section -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">Navigation</div>
      <button onclick="switchTab('editor')" id="sidebar-editor" class="sidebar-item active" title="Editor">
        <i data-lucide="edit-3" class="w-5 h-5"></i>
        <span>Editor</span>
      </button>
      <button onclick="switchTab('suppliers')" id="sidebar-suppliers" class="sidebar-item" title="Suppliers">
        <i data-lucide="users" class="w-5 h-5"></i>
        <span>Suppliers</span>
      </button>
      <button onclick="switchTab('report')" id="sidebar-report" class="sidebar-item" title="Report">
        <i data-lucide="file-text" class="w-5 h-5"></i>
        <span>Report</span>
      </button>
    </div>

    <!-- Tools Section -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">Tools</div>
      <button onclick="setTool('pin')" class="sidebar-item" title="Mark (Pin)">
        <i data-lucide="map-pin" class="w-5 h-5"></i>
        <span>Mark (Pin)</span>
      </button>
      <button onclick="setTool('rect')" class="sidebar-item" title="Rectangle">
        <i data-lucide="square" class="w-5 h-5"></i>
        <span>Rectangle</span>
      </button>
      <button onclick="setTool('line')" class="sidebar-item" title="Measure">
        <i data-lucide="ruler" class="w-5 h-5"></i>
        <span>Measure</span>
      </button>
      <button onclick="setTool('poly')" class="sidebar-item" title="Polygon Area">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4 2 7-6.5-5-6.5 5 2-7-5.5-4h7l3-7z"/></svg>
        <span>Polygon Area</span>
      </button>
      <button onclick="setTool('subtract')" class="sidebar-item" title="Subtract Area">
        <i data-lucide="minus-circle" class="w-5 h-5"></i>
        <span>Subtract Area</span>
      </button>
    </div>

    <!-- Edit Section -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">Edit</div>
      <button onclick="setTool('clone')" class="sidebar-item" title="Clone">
        <i data-lucide="copy" class="w-5 h-5"></i>
        <span>Clone</span>
      </button>
      <button onclick="setTool('eraser')" class="sidebar-item" title="Eraser">
        <i data-lucide="eraser" class="w-5 h-5"></i>
        <span>Eraser</span>
      </button>
      <button onclick="setTool('edit-mark')" class="sidebar-item" title="Edit Mark">
        <i data-lucide="pencil" class="w-5 h-5"></i>
        <span>Edit Mark</span>
      </button>
    </div>

    <!-- View Section -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">View</div>
      <button onclick="openVisibilityControl()" class="sidebar-item" title="Visibility">
        <i data-lucide="eye" class="w-5 h-5"></i>
        <span>Visibility</span>
      </button>
      <button onclick="performUndo()" id="btn-undo-sidebar" class="sidebar-item" title="Undo">
        <i data-lucide="undo-2" class="w-5 h-5"></i>
        <span>Undo</span>
      </button>
      <button onclick="performRedo()" id="btn-redo-sidebar" class="sidebar-item" title="Redo">
        <i data-lucide="redo-2" class="w-5 h-5"></i>
        <span>Redo</span>
      </button>
    </div>

    <!-- System Section (Push to bottom) -->
    <div class="sidebar-section mt-auto border-t border-white/10">
      <div class="sidebar-section-title">System</div>
      <button onclick="toggleFullScreen()" class="sidebar-item" title="Full Screen">
        <i data-lucide="maximize" class="w-5 h-5"></i>
        <span>Full Screen</span>
      </button>
      <button onclick="document.getElementById('modal-exit-program').classList.add('active')" class="sidebar-item hover:bg-red-500/20" title="Exit">
        <i data-lucide="power" class="w-5 h-5"></i>
        <span>Exit</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTAINER -->
  <div id="main-container" class="flex-1 flex flex-col overflow-hidden">
    <!-- HEADER -->
    <header class="text-white px-6 py-3 flex items-center justify-between shadow-lg sticky top-0 z-30" style="overflow-x: auto; flex-wrap: wrap;">
    <div id="requester-display" style="position: absolute; right: 20px; top: 3px; font-size: 10px; color: #cbd5e1; display: none;">
      <span>Requester: <b id="requester-name"></b></span>
    </div>
    <div class="flex items-center gap-4">
      <!-- Database Connection Status -->
      <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/10" style="min-width: fit-content; flex-shrink: 0;">
        <span id="conn-indicator" class="status-light status-amber"></span>
        <span id="conn-text" class="text-[10px] font-bold uppercase tracking-widest text-slate-300">Connecting…</span>
        <button id="btn-refresh-db" class="ml-2 text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition flex items-center gap-1 flex-shrink-0"><i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i><span>Refresh</span></button>
      </div>
      <!-- Authenticated User Status -->
      <div class="ml-3 flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/10">
        <span id="auth-ind" class="status-light status-red"></span>
        <span id="auth-text" class="text-[10px] font-bold uppercase tracking-widest text-slate-300">Not authenticated</span>
        <button id="btn-logout" class="hidden ml-2 text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition flex items-center gap-1"><i data-lucide="log-out" class="w-3.5 h-3.5"></i><span>Logout</span></button>
      </div>
    </div>
    <!-- Project: Name + Start Date + Actions -->
    <div class="flex items-center gap-3">
      <div class="flex flex-col">
        <span class="text-[10px] uppercase font-bold text-slate-300 tracking-wider">Project Name</span>
        <input id="project-name" type="text" placeholder="E.g.: Aurora Tower" class="w-56 bg-white/10 border border-white/10 text-white placeholder:text-slate-300 px-3 py-1.5 rounded-lg outline-none focus:border-indigo-400">
      </div>
      <div class="flex flex-col">
        <span class="text-[10px] uppercase font-bold text-slate-300 tracking-wider">Start Date</span>
        <input id="project-start" type="date" class="w-40 bg-white/10 border border-white/10 text-white px-3 py-1.5 rounded-lg outline-none focus:border-indigo-400" style="max-width: 140px;">
      </div>
      <input type="file" id="pdf-upload" accept="application/pdf" class="hidden" />
      <button onclick="document.getElementById('pdf-upload').click()" class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 px-5 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg"><i data-lucide="file-up" class="w-4 h-4"></i> Load PDF</button>
      <!-- Save/Recover Project (PDF ALWAYS) -->
      <button onclick="saveProject()" class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg"><i data-lucide="save" class="w-4 h-4"></i> Save</button>
      <input type="file" id="project-load" accept="application/json" class="hidden" />
      <button onclick="document.getElementById('project-load').click()" class="bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg"><i data-lucide="upload" class="w-4 h-4"></i> Recover</button>
      <button onclick="integrateProject()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg"><i data-lucide="merge" class="w-4 h-4"></i> Integrate</button>
      <button onclick="toggleFullScreen()" id="btn-fullscreen" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg"><i data-lucide="maximize" class="w-4 h-4"></i> Full Screen</button>
      <button onclick="document.getElementById('copyright-warning-modal').classList.add('active')" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg" title="View Legal Notice & Copyright"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Legal</button>
      <button onclick="document.getElementById('modal-exit-program').classList.add('active')" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 shadow-lg"><i data-lucide="power" class="w-4 h-4"></i> Exit</button>
    </div>
    </header>

  <!-- Toolbar -->
  <div id="toolbar-editor" class="bg-white border-b px-4 py-2 flex items-center gap-6 shadow-sm z-20">
    <!-- Sheet Identification -->
    <div class="flex flex-col gap-1">
      <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Sheet Identification</span>
      <div class="flex items-center gap-2">
        <input id="sheet-id-input" type="text" placeholder="E.g.: A1.0, A2.0" class="bg-white border border-slate-300 px-3 py-1.5 rounded-lg text-xs font-bold outline-none focus:border-indigo-500" style="width: 140px; max-width: 140px;">
        <button onclick="saveSheetId()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex-shrink-0" title="Save sheet identification"><i data-lucide="save" class="w-3.5 h-3.5"></i></button>
      </div>
      <div id="sheet-error-msg" class="text-[10px] text-red-500 font-bold hidden">Project name required</div>
    </div>
    <!-- Scale -->
    <div class="flex flex-col gap-1">
      <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Scaled Drawing</span>
      <div class="flex items-center bg-slate-50 p-1 rounded-xl border border-slate-200 gap-2">
        <button onclick="setTool('scale')" id="tool-scale" class="tool-btn flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold text-amber-600 hover:bg-white transition" title="Click to calibrate scale. Hover for details.">
          <i data-lucide="scale" class="w-4 h-4"></i> Calibrate
        </button>
        <div id="scale-status" class="text-[10px] font-bold text-slate-400 ml-1 hidden">No Scale</div>
      </div>
    </div>
    <!-- Properties -->
    <div class="flex flex-col gap-1">
      <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Mark Properties</span>
      <div class="flex items-center bg-slate-50 p-1 rounded-xl border border-slate-200 gap-1">
        <div class="flex items-center px-2 gap-2"><input type="color" id="prop-color" value="#4f46e5" class="w-6 h-6 rounded border-none cursor-pointer bg-transparent"></div>
        <select id="prop-preset" class="text-xs bg-white border border-slate-300 px-2 py-1 rounded-lg cursor-pointer font-medium" title="Load previous property" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><option value="">Previous marks...</option></select>
      </div>
    </div>
    <!-- Zoom -->
    <div class="ml-auto flex items-center gap-4">
      <div class="flex flex-col gap-1">
        <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Zoom</span>
        <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
          <button onclick="zoom(0.8)" class="p-1 hover:bg-white rounded transition"><i data-lucide="minus" class="w-4 h-4"></i></button>
          <span id="zoom-text" class="px-2 text-xs font-bold text-slate-700">100%</span>
          <button onclick="zoom(1.2)" class="p-1 hover:bg-white rounded transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
        </div>
      </div>
    </div>
  </div>

  <main class="flex-1 overflow-hidden relative flex flex-col">
    <div id="alert" class="hidden items-center justify-between bg-amber-50 text-amber-800 border border-amber-200 mx-4 mt-3 px-4 py-2 rounded-md text-sm z-50 absolute top-0 left-0 right-0 shadow-md">
      <span id="alert-text"></span>
      <button onclick="clearAlert()" class="ml-4 -mr-1 p-1 rounded-md hover:bg-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-500">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <div id="tab-editor" class="tab-content active">
      <div class="viewer-main" id="main-scroll">
        <div id="canvas-wrapper">
          <canvas id="pdf-canvas"></canvas>
          <canvas id="annotation-canvas"></canvas>
          <div id="hover-tooltip"></div>
        </div>
      </div>
      <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-2 rounded-full flex items-center gap-6 shadow-2xl border border-white/10">
        <button onclick="changePage(-1)" class="hover:text-indigo-400"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
        <span id="page-info" class="text-[10px] font-black uppercase tracking-widest">PAGE 1 / 1</span>
        <button onclick="changePage(1)" class="hover:text-indigo-400"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
      </div>
    </div>

    <!-- ====== SUPPLIERS ====== -->
    <div id="tab-suppliers" class="tab-content bg-slate-50 p-6 overflow-y-auto">
      <div class="max-w-7xl mx-auto w-full h-full flex gap-6">
        <!-- Sidebar: Supplier List -->
        <div class="w-1/3 flex flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-black text-slate-800">Suppliers</h2>
            <button onclick="openSupplierModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-lg shadow transition"><i data-lucide="plus" class="w-5 h-5"></i></button>
          </div>
          <div id="suppliers-list" class="flex-1 overflow-y-auto space-y-3 pr-2">
            <!-- Dynamic render -->
            <div class="text-center text-slate-400 text-sm py-10">No suppliers registered.</div>
          </div>
        </div>

        <!-- Main: Detail and Requests -->
        <div class="w-2/3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
          <div id="supplier-detail-empty" class="flex-1 flex flex-col items-center justify-center text-slate-400">
            <i data-lucide="users" class="w-16 h-16 mb-4 opacity-20"></i>
            <p>Select a supplier to view details</p>
          </div>

          <div id="supplier-detail-content" class="hidden flex-col h-full">
            <div class="p-6 border-b bg-slate-50 flex justify-between items-start">
              <div>
                <h3 id="detail-name" class="text-2xl font-black text-slate-800">Supplier Name</h3>
                <div class="flex gap-4 mt-2 text-sm text-slate-600">
                  <span id="detail-contact" class="flex items-center gap-1"><i data-lucide="user" class="w-4 h-4"></i> <span>-</span></span>
                  <span id="detail-email" class="flex items-center gap-1"><i data-lucide="mail" class="w-4 h-4"></i> <span>-</span></span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="openSupplierProfile(activeSupplierId)" class="px-3 py-2 rounded-xl text-xs font-bold bg-slate-200 hover:bg-slate-300 text-slate-700 flex items-center gap-2"><i data-lucide="square-pen" class="w-4 h-4"></i> Edit</button>
                <button onclick="openRequestModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow flex items-center gap-2"><i data-lucide="file-plus" class="w-4 h-4"></i> New Quote</button>
              </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
              <h4 class="text-sm font-bold uppercase text-slate-400 mb-4 tracking-wider">Request History</h4>
              <div id="requests-list" class="space-y-4"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== FINAL REPORT ====== -->
    <div id="tab-report" class="tab-content bg-white p-8 overflow-y-auto">
      <div class="max-w-7xl mx-auto w-full space-y-8">
        <div>
          <h2 class="text-2xl font-black text-slate-800 mb-3">Category Totals</h2>
          <div class="bg-white border rounded-2xl overflow-hidden shadow-sm">
            <table class="w-full text-left">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Division</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Subdivision</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Comment</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Type</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Color</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400 text-center">Revision</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400 text-right">Total</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400 text-right"># Marks</th>
                </tr>
              </thead>
              <tbody id="group-body" class="divide-y"></tbody>
            </table>
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-black text-slate-800 mb-3">Details</h2>
          <div class="bg-white border rounded-2xl overflow-hidden shadow-sm">
            <table class="w-full text-left">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Division</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Subdivision</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Comment</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Location</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400">Type</th>
                  <th class="px-4 py-3 text-[10px] font-bold uppercase text-slate-400 text-right">Quantity</th>
                  <th class="px-4 py-3"></th>
                </tr>
              </thead>
              <tbody id="db-body" class="divide-y"></tbody>
            </table>
          </div>
          <button onclick="exportData()" class="mt-6 bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-emerald-700 transition"><i data-lucide="download" class="w-5 h-5"></i> Export to Excel</button>
        </div>
        <div id="revision-notes" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl hidden">
          <div class="text-sm font-bold text-blue-900 mb-2">Revised Items Notice</div>
          <div class="text-xs text-blue-800">The following items marked with (R) have been revised from their original submission and contain new descriptions or specifications:</div>
          <ul id="revision-items-list" class="text-xs text-blue-800 mt-2 ml-4"></ul>
        </div>
      </div>
    </div>
  </main>

  <footer class="px-6 py-3 bg-gradient-to-r from-slate-900 to-slate-800 border-t border-slate-700 flex flex-col items-center justify-center text-sm shadow-lg text-slate-400 gap-2">
    <div>Active Project: <b id="footer-proj" class="text-slate-200">—</b> · Start: <b id="footer-start" class="text-slate-200">—</b></div>
    <div class="copyright-notice">
      © 2026 Ricardo Rivera Blanco. TakeOffFly (Puerto Rico). All Rights Reserved. | 
      <button onclick="document.getElementById('copyright-warning-modal').classList.add('active')" class="underline hover:text-indigo-400 transition">View Legal Notice</button> |
      Developed with AI-Assisted Technology
    </div>
  </footer>
  </div>

  <!-- Modal CSI -->
  <div id="modal-csi" class="modal">
    <div class="bg-white rounded-3xl p-8 w-[560px] shadow-2xl">
      <h3 id="csi-modal-title" class="text-xl font-black text-slate-800 mb-4">Mark Details</h3>
      <input type="hidden" id="editing-mark-id">
      <div class="flex items-center justify-between bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 mb-4">
        <label for="repeat-props" class="flex items-center gap-2 cursor-pointer select-none">
          <input id="repeat-props" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
          <span class="text-sm font-bold text-slate-700">Repeat properties</span>
        </label>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Color</label>
          <input type="color" id="csi-color" class="w-full h-10 p-1 bg-white border rounded-xl">
        </div>
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">1. CSI Division</label>
          <select id="csi-division" onchange="updateSubdivisions()" class="w-full bg-slate-50 border p-3 rounded-xl font-bold outline-none focus:border-indigo-500"></select>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">2. Category / Subdivision</label>
          <select id="csi-subdivision" class="w-full bg-slate-50 border p-3 rounded-xl font-bold outline-none focus:border-indigo-500"></select>
          <div class="mt-2 flex items-center gap-2 text-xs">
            <input id="toggle-manual-sub" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            <label for="toggle-manual-sub" class="text-slate-600 font-medium select-none">Add sub-section manually</label>
          </div>
          <div id="manual-sub-wrap" class="mt-2 hidden">
            <input id="csi-subdivision-manual" type="text" class="w-full bg-white border p-3 rounded-xl font-bold outline-none focus:border-indigo-500" placeholder="E.g.: 08 44 13 - Curtain Wall (code - description)">
            <p class="text-[11px] text-slate-400 mt-1">If you write here, this sub-section will be used instead of the list.</p>
          </div>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">3. Comment (Detail)</label>
          <textarea id="csi-comment" rows="3" class="w-full bg-slate-50 border p-3 rounded-xl font-medium text-sm outline-none focus:border-indigo-500" placeholder="E.g: Type A Window, Bronze Color..."></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button onclick="closeCSIModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">Cancel</button>
          <button id="csi-save-btn" onclick="saveMark()" class="flex-2 bg-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg">Save Mark</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal New Supplier -->
  <div id="modal-supplier" class="modal">
    <div class="bg-white rounded-3xl p-8 w-[400px] shadow-2xl">
      <h3 class="text-xl font-black text-slate-800 mb-4">New Supplier</h3>
      <div class="space-y-3">
        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Company / Name</label><input id="sup-name" type="text" class="w-full bg-slate-50 border p-3 rounded-xl font-bold outline-none focus:border-indigo-500"></div>
        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Contact</label><input id="sup-contact" type="text" class="w-full bg-slate-50 border p-3 rounded-xl font-medium outline-none focus:border-indigo-500"></div>
        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Email</label><input id="sup-email" type="email" class="w-full bg-slate-50 border p-3 rounded-xl font-medium outline-none focus:border-indigo-500"></div>
        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Phone</label><input id="sup-phone" type="text" class="w-full bg-slate-50 border p-3 rounded-xl font-medium outline-none focus:border-indigo-500"></div>
        <div class="flex gap-3 pt-4">
          <button onclick="document.getElementById('modal-supplier').classList.remove('active')" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">Cancel</button>
          <button onclick="saveSupplier()" class="flex-2 bg-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Supplier Profile / Edit -->
  <div id="modal-supplier-profile" class="modal">
    <div class="bg-white rounded-3xl p-8 w-[520px] shadow-2xl border border-slate-200">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-black text-slate-800">Supplier Profile</h3>
        <button onclick="document.getElementById('modal-supplier-profile').classList.remove('active')" class="rounded-lg px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold">Close</button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div class="col-span-2">
          <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Company / Name</label>
          <input id="edit-sup-name" type="text" class="w-full bg-slate-50 border p-3 rounded-xl font-bold outline-none focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Contact</label>
          <input id="edit-sup-contact" type="text" class="w-full bg-slate-50 border p-3 rounded-xl font-medium outline-none focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Email</label>
          <input id="edit-sup-email" type="email" class="w-full bg-slate-50 border p-3 rounded-xl font-medium outline-none focus:border-indigo-500">
        </div>
        <div class="col-span-2">
          <label class="block text-[10px] font-bold uppercase text-slate-400 mb-1">Phone</label>
          <input id="edit-sup-phone" type="text" class="w-full bg-slate-50 border p-3 rounded-xl font-medium outline-none focus:border-indigo-500">
        </div>
      </div>
      <div class="flex items-center justify-between mt-5">
        <button onclick="deleteSupplier(activeSupplierId)" class="text-red-600 hover:text-red-700 flex items-center gap-1 text-sm font-bold"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
        <div class="flex gap-2">
          <button onclick="document.getElementById('modal-supplier-profile').classList.remove('active')" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 font-bold">Cancel</button>
          <button onclick="updateSupplier()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Request (Create / Edit) -->
  <div id="modal-request" class="modal">
    <div class="bg-white rounded-3xl w-[900px] max-h-[90vh] shadow-2xl flex flex-col">
      <div class="p-6 border-b">
        <h3 id="req-modal-title" class="text-xl font-black text-slate-800">Create Quote Request</h3>
        <p class="text-sm text-slate-500">Select scope (Pages and Items) to send to supplier.</p>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-6">
        <!-- Page Selection -->
        <div>
          <h4 class="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4 text-indigo-500"></i> Plan Pages</h4>
          <div id="req-pages-container" class="grid grid-cols-8 gap-2">
            <!-- Page checkboxes with Sheet IDs -->
          </div>
        </div>
        <!-- Individual Items Selection -->
        <div class="mb-2">
          <button onclick="toggleReqDetail()" class="text-xs font-bold text-indigo-600 flex items-center gap-2 hover:underline select-none bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100">
            <i data-lucide="list-filter" class="w-4 h-4"></i> Filter by Individual Items (CSI)
          </button>
          <div id="req-detail-list" class="hidden mt-2 border rounded-xl p-2 max-h-48 overflow-y-auto bg-slate-50 space-y-1 shadow-inner"></div>
        </div>
        <!-- Items Selection -->
        <div>
          <h4 class="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="list-checks" class="w-4 h-4 text-indigo-500"></i> Project Items (Report)</h4>
          <div class="border rounded-xl overflow-hidden">
            <table class="w-full text-left text-sm">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-4 py-2 w-10"><input type="checkbox" onchange="toggleAllReqItems(this)" class="rounded border-slate-300 text-indigo-600"></th>
                  <th class="px-4 py-2 font-bold text-slate-500">Division</th>
                  <th class="px-4 py-2 font-bold text-slate-500">Subdivision</th>
                  <th class="px-4 py-2 font-bold text-slate-500">Comment</th>
                  <th class="px-4 py-2 font-bold text-slate-500 text-right">From Report</th>
                  <th class="px-4 py-2 font-bold text-slate-500 text-right">Request (Qty)</th>
                </tr>
              </thead>
              <tbody id="req-items-body" class="divide-y">
                <!-- Rows generated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Notes -->
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Additional Notes</label>
          <textarea id="req-notes" rows="2" class="w-full bg-slate-50 border p-3 rounded-xl font-medium text-sm outline-none focus:border-indigo-500" placeholder="Special instructions for supplier..."></textarea>
        </div>
      </div>
      <div class="p-6 border-t bg-slate-50 rounded-b-3xl flex justify-end gap-3">
        <button onclick="closeRequestModal()" class="px-6 py-2 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition">Cancel</button>
        <button id="req-save-btn" onclick="saveRequest()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold shadow-lg transition">Create Request</button>
      </div>
    </div>
  </div>

  <!-- Modal Calibración -->
  <div id="modal-scale" class="modal">
    <div class="bg-white rounded-3xl p-8 w-[400px]">
      <h3 class="text-xl font-black text-slate-800 mb-6">Calibrate</h3>
      <div class="space-y-4">
        <input type="number" id="real-dim" class="w-full bg-slate-50 border p-4 rounded-xl font-bold text-lg" placeholder="Real Dimension" />
        <select id="unit-scale" class="w-full bg-slate-50 border p-4 rounded-xl font-bold">
          <option value="ft">Feet (ft)</option>
          <option value="m">Meters (m)</option>
        </select>
        <button onclick="saveScale()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">Calibrate System</button>
      </div>
    </div>
  </div>

  <!-- Modal Visibility -->
  <div id="modal-visibility" class="modal">
    <div class="bg-white rounded-3xl p-8 w-[600px] shadow-2xl">
        <h3 class="text-xl font-black text-slate-800 mb-4">Mark Visibility Control</h3>
        <div class="flex items-center gap-4 mb-4">
            <button onclick="toggleAllVisibility(true)" class="text-xs font-bold bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded">Select All</button>
            <button onclick="toggleAllVisibility(false)" class="text-xs font-bold bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded">Deselect All</button>
        </div>
        <div id="visibility-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
            <!-- Dynamic content -->
        </div>
        <div class="flex justify-end mt-6">
            <button onclick="applyVisibility()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">Apply</button>
        </div>
    </div>
  </div>

  <!-- Modal Full Screen Prompt -->
  <div id="modal-fullscreen-prompt" class="modal" style="z-index: 200;">
    <div class="bg-white rounded-3xl p-8 w-[400px] shadow-2xl text-center flex flex-col items-center">
      <img src="https://storage.googleapis.com/permisos-takeoff/takeoffly%20Logo.png" alt="Logo" class="h-16 mb-4">
      <p class="text-lg font-bold text-slate-800 mb-6">This program will be displayed in Full Screen mode</p>
      <button onclick="triggerFullScreenApp()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg">OK</button>
    </div>
  </div>

  <!-- Modal Exit Program -->
  <div id="modal-exit-program" class="modal" style="z-index: 200;">
    <div class="bg-white rounded-3xl p-8 w-[400px] shadow-2xl text-center">
      <h3 class="text-xl font-black text-slate-800 mb-4">Exit Program</h3>
      <p class="text-sm text-slate-600 mb-6">Do you want to save changes before exiting?</p>
      <div class="flex gap-3 justify-center">
        <button onclick="confirmExit(true)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg">Save Changes</button>
        <button onclick="confirmExit(false)" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-3 rounded-xl font-bold">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal Subtract Area -->
  <div id="modal-subtract-area" class="modal">
    <div class="bg-white rounded-3xl p-8 w-[450px] shadow-2xl">
      <h3 class="text-xl font-black text-slate-800 mb-4">Subtract Area</h3>
      <p class="text-sm text-slate-600 mb-4">Enter the amount to subtract from this marker (e.g., for a window or door).</p>
      <div class="space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Current Area</label>
          <div class="bg-slate-50 border border-slate-200 p-3 rounded-xl font-bold text-slate-700" id="current-area-display">—</div>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Amount to Subtract</label>
          <div class="flex items-center gap-2">
            <input type="number" id="subtract-amount" class="flex-1 bg-slate-50 border border-slate-200 p-3 rounded-xl font-bold outline-none focus:border-indigo-500" placeholder="e.g., 50" min="0" step="0.01">
            <span id="subtract-unit" class="text-slate-600 font-bold min-w-fit">sf</span>
          </div>
        </div>
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Resulting Area</label>
          <div class="bg-indigo-50 border border-indigo-200 p-3 rounded-xl font-bold text-indigo-700" id="result-area-display">—</div>
        </div>
        <div class="flex gap-3 pt-4">
          <button onclick="closeSubtractAreaModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">Cancel</button>
          <button onclick="applySubtraction()" class="flex-1 bg-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg">Apply Subtraction</button>
        </div>
      </div>
    </div>
  </div>

  </div>

  <script>
  // ======= Constantes =======
  const CSI_DB_URL = "https://script.google.com/macros/s/AKfycbyBDn_BiD-QjMb0PkLcm7KmPDF2p2i5NC4SL-iq7KQJBKX-5W6J5RC-9itXTpNPkMfcPA/exec";
  const AUTH_URL   = "https://script.google.com/macros/s/AKfycbz1qoqQPwEynVaJ_44LQxfDAGUbSm1k8Nb83x99tbzeiU2zI6Pc1xpFOpQP8I61EeZV/exec";
  
  const CSI_TITLES = {
    "01": "General Requirements",
    "02": "Existing Conditions",
    "03": "Concrete",
    "04": "Masonry",
    "05": "Metals",
    "06": "Wood, Plastics, and Composites",
    "07": "Thermal and Moisture Protection",
    "08": "Openings",
    "09": "Finishes",
    "10": "Specialties",
    "11": "Equipment",
    "12": "Furnishings",
    "13": "Special Construction",
    "14": "Conveying Equipment",
    "21": "Fire Suppression",
    "22": "Plumbing",
    "23": "Heating, Ventilating, and Air Conditioning (HVAC)",
    "25": "Integrated Automation",
    "26": "Electrical",
    "27": "Communications",
    "28": "Electronic Safety and Security",
    "31": "Earthwork",
    "32": "Exterior Improvements",
    "33": "Utilities",
    "34": "Transportation",
    "35": "Waterway and Marine Construction",
    "40": "Process Integration",
    "41": "Material Processing and Handling Equipment",
    "42": "Process Heating, Cooling, and Drying Equipment",
    "43": "Process Gas and Liquid Handling, Purification, and Storage Equipment",
    "44": "Pollution Control and Waste Equipment",
    "45": "Industry-Specific Manufacturing Equipment",
    "46": "Water and Wastewater Equipment",
    "48": "Electrical Power Generation"
  };

  // ======= Estado Global =======
  let pdfDoc = null, currentPage = 1, zoomLevel = 1.0;
  let baseScale = 0; // pixels per unit at zoom 1.0
  let currentUnit = 'ft', currentTool = 'select';
  let visibilityFilters = new Map(); // key -> boolean, includes page context
  let measurements = [], isDrawing=false, startPointPx=null;
  // Undo/Redo system
  let undoStack = [], redoStack = [], currentStateSnapshot = null;
  let sheetIdentifications = {};
  let csiRows = [], csiDivMap = new Map();
  let selectedId = null;
  let editingMarkId = null;
  let polyActive=false; let polyPointsPx=[];
  let cloneSource=null;
  let suppliers = [], supplierRequests = [];
  let lastCSIProps=null;
  let pendingMark=null;
  let requesterName = localStorage.getItem('requesterName') || 'Unknown User';

  // PDF original bytes + name
  window._originalPdfBytes = null; window._originalPdfName = null;

  // ======= Utilidades =======
  function alertMsg(msg){
    const a = document.getElementById('alert');
    const alertText = document.getElementById('alert-text');
    alertText.textContent = msg;
    a.classList.remove('hidden');
    a.classList.add('flex');
    lucide.createIcons();
  }
  function clearAlert(){
    const a = document.getElementById('alert');
    a.classList.add('hidden');
  }
  const $ = sel => document.querySelector(sel);
  function sanitizeName(s){ return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\-\s\.]+/g,'').trim().replace(/\s+/g,'_').slice(0,80) || 'Project'; }
  function isDark(color) {
    if (!color) return false;
    const c = color.substring(1);
    const rgb = parseInt(c, 16);
    const r = (rgb >> 16) & 0xff;
    const g = (rgb >> 8) & 0xff;
    const b = (rgb >> 0) & 0xff;
    const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
    return luma < 128;
  }

  // ======= Autenticación =======
  async function sha256(message){ const enc = new TextEncoder(); const buf = await crypto.subtle.digest('SHA-256', enc.encode(message)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function deviceFingerprint(){
    const nav = navigator; const screen = window.screen;
    return [nav.userAgent, nav.language, screen.colorDepth, screen.width+'x'+screen.height, new Date().getTimezoneOffset(), nav.hardwareConcurrency||'hz', nav.deviceMemory||'mem'].join('\n');
  }
  async function makeDeviceHash(){ return sha256(deviceFingerprint()); }
  async function tryAutoLogin(){
    const saved = JSON.parse(localStorage.getItem('authV14')||'null');
    if(!saved){ showAuth(); return; }
    const devhash = await makeDeviceHash();
    try {
      const res = await fetch(AUTH_URL, { method: 'POST', body: JSON.stringify({ action:'resume', email: saved.email, token: saved.token, deviceHash: devhash }) });
      const data = await res.json();
      if(data.ok){
        setAuthUI(true, data.email, data.name);
        document.getElementById('modal-fullscreen-prompt').classList.add('active');
      } else {
        console.warn('Session expired', data);
        localStorage.removeItem('authV14');
        showAuth(data.message || 'Session expired');
      }
    } catch(e){
      console.error(e);
      showAuth('Connection error validating session.');
    }
  }
  function showAuth(msg){ $('#auth-modal').classList.add('active'); if(msg){ const m=$('#auth-msg'); m.textContent=msg; m.classList.remove('hidden'); } }
  function hideAuth(){ $('#auth-modal').classList.remove('active'); $('#auth-msg').classList.add('hidden'); $('#auth-msg').textContent=''; }
  function setAuthUI(ok, email, name){
    const ind = $('#auth-ind'); const t = $('#auth-text'); const btn = $('#btn-logout');
    if(ok){ 
      ind.className='status-light status-green'; 
      t.textContent=name ? `Hello, ${name}` : email; 
      btn.classList.remove('hidden'); 
      hideAuth();
      // Set requester name
      requesterName = name || email;
      localStorage.setItem('requesterName', requesterName);
      const requesterDisplay = document.getElementById('requester-display');
      const requesterNameEl = document.getElementById('requester-name');
      if(requesterDisplay && requesterNameEl) {
        requesterNameEl.textContent = requesterName;
        requesterDisplay.style.display = 'block';
      }
    }
    else { ind.className='status-light status-red'; t.textContent='No autenticado'; btn.classList.add('hidden'); }
  }
  function requestFullScreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(err => console.log(`Fullscreen request failed: ${err.message}`));
    } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
    } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
    } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
    }
  }
  function triggerFullScreenApp(){
    requestFullScreen();
    document.getElementById('modal-fullscreen-prompt').classList.remove('active');
  }
  async function doLogin(){
    const email = ($('#auth-email').value||'').toLowerCase().trim();
    const secret = $('#auth-secret').value.trim();
    if(!email || !secret){ showAuth('Complete email and key.'); return; }
    const devhash = await makeDeviceHash();
    const btn = $('#btn-auth'); const originalText = btn.innerHTML;
    btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Entrando...'; btn.disabled=true;
    try {
      const res = await fetch(AUTH_URL, { method: 'POST', body: JSON.stringify({ action:'auth', email, secret, deviceHash: devhash }) });
      const data = await res.json();
      if(data.ok){
        localStorage.setItem('authV14', JSON.stringify({ email: data.email, token: data.token, deviceHash: devhash, name: data.name, ts: Date.now() }));
        setAuthUI(true, data.email, data.name);
        document.getElementById('modal-fullscreen-prompt').classList.add('active');
      } else {
        showAuth(data.message || 'Invalid credentials');
      }
    } catch(e){ console.error(e); showAuth('Server connection error.'); }
    finally { btn.innerHTML = originalText; btn.disabled=false; lucide.createIcons(); }
  }
  function doLogout(){ localStorage.removeItem('authV14'); setAuthUI(false); showAuth(); }

  // ======= Carga de DB CSI =======
  async function fetchCSIData(retry=0,manual=false){
    const indicator=document.getElementById('conn-indicator'); const text=document.getElementById('conn-text');
    indicator.className='status-light status-amber'; text.textContent=manual?'Actualizando...':'Conectando...'; clearAlert();
    try{
      const res = await fetch(`${CSI_DB_URL}?t=${Date.now()}`,{method:'GET',cache:'no-store',credentials:'omit',headers:{'Accept':'application/json'}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const raw = await res.text(); let data; try{ data=JSON.parse(raw);}catch{ throw new Error('JSON inválido del Apps Script'); }
      const normalized=[];
      if(Array.isArray(data)){
        data.forEach(row=>{
          if(row==null) return;
          if(Array.isArray(row)){ if(row.length>=2) normalized.push({ code:String(row[0]).trim(), desc:String(row[1]).trim() }); }
          else{ const keys=Object.keys(row).reduce((acc,k)=>{acc[k.toLowerCase()]=row[k]; return acc;},{});
            if(keys.division && keys.subdivision){ normalized.push({ code:String(keys.subdivision).trim(), desc:String(keys.descripcion||keys.description||'').trim() }); }
            else if(keys.code){ normalized.push({ code:String(keys.code).trim(), desc:String(keys.descripcion||keys.description||'').trim() }); }
          }
        });
      } else if (Array.isArray(data.data)){ data.data.forEach(r=>{ if(r && r.code){ normalized.push({ code:String(r.code).trim(), desc:String(r.desc||'').trim() }); }}); }
      if(!normalized.length) throw new Error('La DB respondió sin filas reconocibles');
      csiRows = normalized.filter(r=>/\d{2}/.test(r.code));
      csiDivMap = new Map();
      csiRows.forEach(r=>{ const code=r.code.replace(/\./g,''); const d=code.slice(0,2); if(!csiDivMap.has(d)) csiDivMap.set(d,{name:'',items:[]}); csiDivMap.get(d).items.push(r); });
      csiRows.forEach(r=>{ const code=r.code.replace(/\./g,''); const div=code.slice(0,2); if(/^(\d{2})0{2}(0{2})?$/.test(code)){ const v=csiDivMap.get(div); if(v && !v.name) v.name = r.desc || ('Div '+div); }});
      populateDivisionsUI();
      indicator.className='status-light status-green'; text.textContent='Database';
    }catch(err){ console.error(err); alertMsg('Unable to load CSI database.'); if(retry<3){ setTimeout(()=>fetchCSIData(retry+1,manual), 1200*Math.pow(2,retry)); } else { indicator.className='status-light status-red'; text.textContent='Connection Error'; } }
    finally{ lucide.createIcons(); }
  }
  function populateDivisionsUI(){ const sel=document.getElementById('csi-division'); const entries=[...csiDivMap.entries()].sort((a,b)=>a[0].localeCompare(b[0])); sel.innerHTML = entries.map(([d,v])=>`<option value="${d}">${d} - ${v.name || ('División '+d)}</option>`).join(''); updateSubdivisions(); }
  function updateSubdivisions(){ const d=document.getElementById('csi-division').value; const sel=document.getElementById('csi-subdivision'); const v=csiDivMap.get(d); if(!v){ sel.innerHTML=''; return; } sel.innerHTML = v.items.map(it=>`<option value="${it.code}">${it.code} - ${it.desc||''}</option>`).join(''); }

  // ======= UI Tabs =======
  function switchTab(tab){
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.getElementById(`tab-${tab}`).classList.add('active');
    const btnEditor=document.getElementById('tab-btn-editor'); const btnReport=document.getElementById('tab-btn-report'); const btnSupp=document.getElementById('tab-btn-suppliers');
    const sidebarEditor=document.getElementById('sidebar-editor'); const sidebarSupp=document.getElementById('sidebar-suppliers'); const sidebarReport=document.getElementById('sidebar-report');
    const toolbar=document.getElementById('toolbar-editor');
    [btnEditor, btnReport, btnSupp].forEach(b => b.className = 'px-6 py-1.5 rounded-lg text-sm font-bold transition text-slate-300 hover:text-white');
    [sidebarEditor, sidebarSupp, sidebarReport].forEach(b => b.classList.remove('active'));
    if(tab==='editor'){ toolbar.style.display='flex'; btnEditor.className='px-6 py-1.5 rounded-lg text-sm font-bold bg-indigo-600 text-white'; if(sidebarEditor) sidebarEditor.classList.add('active'); }
    else if(tab==='suppliers'){ toolbar.style.display='none'; btnSupp.className='px-6 py-1.5 rounded-lg text-sm font-bold bg-indigo-600 text-white'; if(sidebarSupp) sidebarSupp.classList.add('active'); renderSuppliersView(); }
    else { toolbar.style.display='none'; btnReport.className='px-6 py-1.5 rounded-lg text-sm font-bold bg-indigo-600 text-white'; if(sidebarReport) sidebarReport.classList.add('active'); updateReportTable(); }
    lucide.createIcons();
  }

  // ======= PDF Render =======
  const canvas=document.getElementById('pdf-canvas'); const ctx=canvas.getContext('2d');
  const annCanvas=document.getElementById('annotation-canvas'); const annCtx=annCanvas.getContext('2d');
  const tooltip=document.getElementById('hover-tooltip');

  document.getElementById('pdf-upload').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return; const reader=new FileReader();
    reader.onload=async function(){ const typed=new Uint8Array(this.result); window._originalPdfBytes = typed; window._originalPdfName = file.name; pdfDoc=await pdfjsLib.getDocument(typed).promise; currentPage=1; zoomLevel=1.0; await renderPage(1); if(!csiRows.length) fetchCSIData(); };
    reader.readAsArrayBuffer(file);
  });

  async function renderPage(num){ if(!pdfDoc) return; currentPage=num; const page=await pdfDoc.getPage(num); const viewport=page.getViewport({scale:zoomLevel}); canvas.height=annCanvas.height=viewport.height; canvas.width=annCanvas.width=viewport.width; await page.render({canvasContext:ctx,viewport}).promise; const pageDisplay = `PAGE ${num} / ${pdfDoc.numPages}`; document.getElementById('page-info').textContent=pageDisplay; loadSheetIdForPage(num); draw(); }
  function zoom(f){ zoomLevel=Math.max(.1,Math.min(zoomLevel*f,8)); renderPage(currentPage); document.getElementById('zoom-text').textContent=`${Math.round(zoomLevel*100)}%`; }
  function changePage(d){ if(pdfDoc && currentPage+d>0 && currentPage+d<=pdfDoc.numPages) renderPage(currentPage+d); }
  function loadSheetIdForPage(pageNum){ const input = document.getElementById('sheet-id-input'); if(input){ const projName = document.getElementById('project-name').value.trim(); const key = `sheet-id-${projName}-page-${pageNum}`; const savedId = localStorage.getItem(key); input.value = savedId || ''; } }
  function saveSheetId(){ const projName = document.getElementById('project-name').value.trim(); const input = document.getElementById('sheet-id-input'); const sheetId = input.value.trim(); const errorMsg = document.getElementById('sheet-error-msg'); if(!projName){ errorMsg.classList.remove('hidden'); alertMsg('Please enter the project name first'); return; } errorMsg.classList.add('hidden'); if(!pdfDoc) return; const key = `sheet-id-${projName}-page-${currentPage}`; if(sheetId){ localStorage.setItem(key, sheetId); } else { localStorage.removeItem(key); } alertMsg('Sheet identification saved'); setTimeout(clearAlert, 2000); }
  function saveUndoState(){ currentStateSnapshot = { measurements: JSON.parse(JSON.stringify(measurements)), baseScale, currentUnit }; undoStack.push(currentStateSnapshot); redoStack = []; updateUndoRedoButtons(); }
  function performUndo(){ if(undoStack.length === 0) return; redoStack.push(currentStateSnapshot); currentStateSnapshot = undoStack.pop(); measurements = JSON.parse(JSON.stringify(currentStateSnapshot.measurements)); baseScale = currentStateSnapshot.baseScale; currentUnit = currentStateSnapshot.currentUnit; updateReportTable(); draw(); updateBrandPropertyDropdown(); updateUndoRedoButtons(); alertMsg('Undo completed'); setTimeout(clearAlert, 1500); }
  function performRedo(){ if(redoStack.length === 0) return; undoStack.push(currentStateSnapshot); currentStateSnapshot = redoStack.pop(); measurements = JSON.parse(JSON.stringify(currentStateSnapshot.measurements)); baseScale = currentStateSnapshot.baseScale; currentUnit = currentStateSnapshot.currentUnit; updateReportTable(); draw(); updateBrandPropertyDropdown(); updateUndoRedoButtons(); alertMsg('Redo completed'); setTimeout(clearAlert, 1500); }
  function updateUndoRedoButtons(){ 
    const undoBtn = document.getElementById('btn-undo'); const redoBtn = document.getElementById('btn-redo');
    const undoSidebarBtn = document.getElementById('btn-undo-sidebar'); const redoSidebarBtn = document.getElementById('btn-redo-sidebar');
    const undoDisabled = undoStack.length === 0; const redoDisabled = redoStack.length === 0;
    if(undoBtn) undoBtn.disabled = undoDisabled;
    if(redoBtn) redoBtn.disabled = redoDisabled;
    if(undoSidebarBtn) undoSidebarBtn.disabled = undoDisabled;
    if(redoSidebarBtn) redoSidebarBtn.disabled = redoDisabled;
  }
  function setTool(t){ 
    currentTool=t; polyActive = (t==='poly'); 
    if(!polyActive){ polyPointsPx=[]; } if(t!=='clone'){ cloneSource=null; } 
    document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('ring-2','ring-indigo-500','bg-white','shadow')); 
    const b=document.getElementById(`tool-${t}`); if(b) b.classList.add('ring-2','ring-indigo-500','bg-white','shadow'); 
    if(t==='clone'){ alertMsg('Select a mark to clone'); } else if (t==='edit-mark') { alertMsg('Select the mark you want to edit.'); } else { clearAlert(); } 
  }
  function toCanvas(pt){ return { x: pt.x * annCanvas.width, y: pt.y * annCanvas.height }; }
  function fromCanvas(pt){ return { x: pt.x / annCanvas.width, y: pt.y / annCanvas.height }; }
  function canvasCoords(e){ const r=annCanvas.getBoundingClientRect(); return { x:e.clientX-r.left, y:e.clientY-r.top }; }

  annCanvas.addEventListener('mousedown',e=>{
    const pPx=canvasCoords(e);
    if(currentTool==='clone'){ if(!cloneSource){ const idx = hitTest(pPx, true); if(idx>=0){ cloneSource = measurements[idx]; selectedId = cloneSource.id; draw(); alertMsg('Click to clone. Press Esc to exit.'); } } else { placeCloneAt(pPx); } return; }
    if (currentTool === 'edit-mark') {
        const idx = hitTest(pPx, true);
        if (idx >= 0) {
            openMarkEditor(measurements[idx]);
        }
        return;
    }
    if (currentTool === 'subtract') {
        const idx = hitTest(pPx, true);
        if (idx >= 0) {
            openSubtractAreaModal(measurements[idx]);
        }
        return;
    }
    if(currentTool==='select'){ selectAt(pPx); draw(); return; }
    if(currentTool==='scale'){ isDrawing=true; startPointPx=pPx; return; }
    if(currentTool==='rect'){ isDrawing=true; startPointPx=pPx; return; }
    if(currentTool==='line'){ isDrawing=true; startPointPx=pPx; return; }
    if(currentTool==='pin'){ saveUndoState(); const mark={ type:'pin', start: fromCanvas(pPx), page:currentPage, color:document.getElementById('prop-color').value }; openCSIModal(mark); return; }
    if(currentTool==='poly') { if(!polyActive){ polyActive=true; polyPointsPx=[]; } polyPointsPx.push(pPx); draw(); return; }
    if(currentTool==='eraser'){ const idx = hitTest(pPx); if(idx>=0){ removeMeasurement(measurements[idx].id); draw(); } }
  });

  annCanvas.addEventListener('mousemove',e=>{
    const pPx=canvasCoords(e); const idxHover = hitTest(pPx, true); if(idxHover>=0 && isMeasurementVisible(measurements[idxHover])){ showTooltip(pPx, measurements[idxHover]); } else { hideTooltip(); }
    if(currentTool==='rect' && isDrawing){ draw(); annCtx.save(); annCtx.strokeStyle=document.getElementById('prop-color').value; annCtx.setLineDash([5,5]); annCtx.lineWidth=2; const r=rectFromPoints(startPointPx,pPx); annCtx.strokeRect(r.x,r.y,r.w,r.h); annCtx.restore(); return; }
    if(currentTool==='line' && isDrawing){ draw(); annCtx.save(); annCtx.strokeStyle=document.getElementById('prop-color').value; annCtx.setLineDash([5,5]); annCtx.lineWidth=2; annCtx.beginPath(); annCtx.moveTo(startPointPx.x,startPointPx.y); annCtx.lineTo(pPx.x,pPx.y); annCtx.stroke(); annCtx.restore(); return; }
    if(currentTool==='scale' && isDrawing){ draw(); annCtx.save(); annCtx.strokeStyle='#f59e0b'; annCtx.setLineDash([4,4]); annCtx.lineWidth=2; annCtx.beginPath(); annCtx.moveTo(startPointPx.x,startPointPx.y); annCtx.lineTo(pPx.x,pPx.y); annCtx.stroke(); annCtx.restore(); return; }
    if(currentTool==='poly' && polyActive){ draw(); annCtx.save(); annCtx.strokeStyle=document.getElementById('prop-color').value; annCtx.fillStyle=document.getElementById('prop-color').value+'22'; annCtx.lineWidth=2; annCtx.setLineDash([4,4]); if(polyPointsPx.length>0){ annCtx.beginPath(); annCtx.moveTo(polyPointsPx[0].x,polyPointsPx[0].y); for(let i=1;i<polyPointsPx.length;i++){ annCtx.lineTo(polyPointsPx[i].x, polyPointsPx[i].y); } annCtx.lineTo(pPx.x,pPx.y); annCtx.stroke(); annCtx.fillStyle='#10b98155'; annCtx.beginPath(); annCtx.arc(polyPointsPx[0].x, polyPointsPx[0].y, 6, 0, Math.PI*2); annCtx.fill(); } annCtx.restore(); return; }
  });

  annCanvas.addEventListener('mouseup',e=>{
    const pPx=canvasCoords(e);
    if(currentTool==='rect' && isDrawing){ isDrawing=false; saveUndoState(); const mark={ type:'rect', start: fromCanvas(startPointPx), end: fromCanvas(pPx), page:currentPage, color:document.getElementById('prop-color').value }; openCSIModal(mark); return; }
    if(currentTool==='line' && isDrawing){ isDrawing=false; saveUndoState(); const mark={ type:'line', start: fromCanvas(startPointPx), end: fromCanvas(pPx), page:currentPage, color:document.getElementById('prop-color').value }; openCSIModal(mark); return; }
    if(currentTool==='scale' && isDrawing){ isDrawing=false; window.tempDistPx = distance(startPointPx,pPx); document.getElementById('modal-scale').classList.add('active'); return; }
  });

  annCanvas.addEventListener('dblclick', (e)=>{ if(currentTool==='poly' && polyPointsPx.length>=3){ saveUndoState(); const mark={ type:'poly', points: polyPointsPx.map(pt=>fromCanvas(pt)), page:currentPage, color:document.getElementById('prop-color').value }; polyPointsPx=[]; polyActive=false; openCSIModal(mark); } });

  function selectAt(pPx){ const idx = hitTest(pPx,true); if(idx>=0){ selectedId = measurements[idx].id; } else { selectedId=null; } }
  function hitTest(pPx, precise=false){ let found=-1; let minD=Infinity; for(let i=measurements.length-1;i>=0;i--){ const m=measurements[i]; if(m.page!==currentPage) continue; if(!isMeasurementVisible(m)) continue; let d=Infinity; if(m.type==='pin'){ const sp=toCanvas(m.start); d=distance(pPx,sp); if(d<=10 && d<minD){minD=d; found=i;} } else if(m.type==='rect'){ const r=rectFromPoints(toCanvas(m.start),toCanvas(m.end)); if(pPx.x>=r.x && pPx.x<=r.x+r.w && pPx.y>=r.y && pPx.y<=r.y+r.h){ found=i; break; } } else if(m.type==='line'){ d=pointToSegmentDistance(pPx,toCanvas(m.start),toCanvas(m.end)); if(d<=6 && d<minD){minD=d; found=i;} } else if(m.type==='poly'){ const pts = m.points.map(toCanvas); if(pointInPolygon(pPx,pts)){ found=i; break; } } } return found; }
  function pointToSegmentDistance(p,a,b){ const l2 = Math.pow(distance(a,b),2); if(l2===0) return distance(p,a); let t=((p.x-a.x)*(b.x-a.x)+(p.y-a.y)*(b.y-a.y))/l2; t=Math.max(0,Math.min(1,t)); const proj={x:a.x+t*(b.x-a.x), y:a.y+t*(b.y-a.y)}; return distance(p,proj); }
  function pointInPolygon(p, pts){ let inside=false; for(let i=0,j=pts.length-1;i<pts.length;j=i++){ const xi=pts[i].x, yi=pts[i].y; const xj=pts[j].x, yj=pts[j].y; const intersect=((yi>p.y)!=(yj>p.y)) && (p.x < (xj - xi) * (p.y - yi) / (((yj - yi) || 1e-9)) + xi); if(intersect) inside=!inside; } return inside; }
  function rectFromPoints(a,b){ const x=Math.min(a.x,b.x), y=Math.min(a.y,b.y), w=Math.abs(b.x-a.x), h=Math.abs(b.y-a.y); return {x,y,w,h}; }
  function distance(a,b){ return Math.hypot(b.x-a.x, b.y-a.y); }
  function polygonAreaPx(pts){ let area=0; for(let i=0,j=pts.length-1;i<pts.length;j=i++){ area += (pts[j].x + pts[i].x) * (pts[j].y - pts[i].y); } return Math.abs(area/2); }

  function openCSIModal(tempMark){ 
    pendingMark = tempMark; 
    editingMarkId = null;
    $('#csi-modal-title').textContent = 'Mark Details';
    $('#csi-save-btn').textContent = 'Save Mark';
    $('#csi-color').value = document.getElementById('prop-color').value;
    document.getElementById('modal-csi').classList.add('active'); 
    if(lastCSIProps && (localStorage.getItem('repeatProps')==='1')){ setCSIFields({...lastCSIProps, repeatManualSub: true}); } 
    else { setCSIFields(null); }
  }
  
  function updateMatchingMarkProperties(markType, div, sub, comm, newProps) {
    measurements.forEach(m => {
      if (m.csi && m.csi.div === div && m.csi.sub === sub && (m.csi.comm || '') === (comm || '')) {
        if (newProps.color !== undefined) m.color = newProps.color;
      }
    });
  }
  function openMarkEditor(mark) {
    editingMarkId = mark.id;
    pendingMark = null;
    $('#csi-modal-title').textContent = 'Edit Properties';
    $('#csi-save-btn').textContent = 'Save Changes';
    $('#editing-mark-id').value = mark.id;
    $('#csi-color').value = mark.color;
    setCSIFields(mark.csi);
    $('#modal-csi').classList.add('active');
  }
  function closeCSIModal(){ document.getElementById('modal-csi').classList.remove('active'); document.getElementById('csi-comment').value=''; pendingMark=null; editingMarkId = null; }
  function setCSIFields(props){ if(!props) return; document.getElementById('csi-division').value = props.div; updateSubdivisions(); const manualEnabled = props.sub && !csiDivMap.get(props.div)?.items?.some(i => i.code === props.sub); document.getElementById('csi-subdivision').value = !manualEnabled ? props.sub : ''; document.getElementById('csi-comment').value = props.comm || ''; if(manualEnabled && props.sub){ document.getElementById('toggle-manual-sub').checked = true; document.getElementById('csi-subdivision-manual').value = props.sub; document.getElementById('manual-sub-wrap').classList.remove('hidden'); } else { document.getElementById('toggle-manual-sub').checked = false; document.getElementById('manual-sub-wrap').classList.add('hidden'); document.getElementById('csi-subdivision-manual').value=''; } }

  function saveMark(){
    saveUndoState();
    const div = $('#csi-division').value; let sub = $('#csi-subdivision').value; const comm = $('#csi-comment').value.trim();
    const manualEnabled = $('#toggle-manual-sub').checked; const subManualRaw = manualEnabled ? ($('#csi-subdivision-manual').value||'').trim() : '';
    if(manualEnabled && subManualRaw){ sub = subManualRaw; /* ... logic to add to csiDivMap if new ... */ }
    const color = $('#csi-color').value;

    if (editingMarkId) {
        const mark = measurements.find(m => m.id === editingMarkId);
        if (mark) {
            const oldColor = mark.color;
            mark.csi = { div, sub, comm };
            mark.color = color;
            lastCSIProps = {div, sub, comm};
            // Update all matching marks with same properties
            if (oldColor !== color) {
              updateMatchingMarkProperties(mark.type, div, sub, comm, { color });
            }
        }
    } else if (pendingMark) {
        let rawVal=0, unit=currentUnit, type=pendingMark.type; let value=0;
        if(type==='pin' || type==='rect'){ rawVal=1; unit='unid'; value=1; }
        else if(type==='line'){ const a=toCanvas(pendingMark.start), b=toCanvas(pendingMark.end); rawVal=distance(a,b); value = (baseScale>0) ? rawVal/(baseScale*zoomLevel) : 0; unit=currentUnit; }
        else if(type==='poly'){ const pointsPx = pendingMark.points.map(toCanvas); rawVal = polygonAreaPx(pointsPx); value = (baseScale>0) ? rawVal/Math.pow(baseScale*zoomLevel,2) : 0; unit=currentUnit; }

        const mark = { id:Date.now(), type, page:currentPage, color, unit, csi:{div, sub, comm} };
        if(type==='pin'){ mark.start = pendingMark.start; }
        if(type==='rect' || type==='line'){ mark.start = pendingMark.start; mark.end = pendingMark.end; }
        if(type==='poly'){ mark.points = pendingMark.points; }
        mark.raw = rawVal; mark.value = value;
        measurements.push(mark); selectedId = mark.id; lastCSIProps = {div, sub, comm};
        // Apply matching mark properties
        updateMatchingMarkProperties(type, div, sub, comm, { color });
    }
    
    closeCSIModal(); 
    draw(); 
    updateReportTable();
    updateBrandPropertyDropdown();
  }

  function saveScale(){
    const real=parseFloat(document.getElementById('real-dim').value); currentUnit=document.getElementById('unit-scale').value;
    if(real>0 && window.tempDistPx>0){
      baseScale = (window.tempDistPx / real) / zoomLevel; const st=document.getElementById('scale-status');
      st.textContent=`Scale: 1 ${currentUnit} = ${baseScale.toFixed(2)} px (Base)`; 
      st.className='text-[11px] font-black text-emerald-600 uppercase tracking-tighter ml-1';
      st.classList.remove('hidden');
      measurements.forEach(m=>{
        if(m.type==='pin' || m.type==='rect'){ m.value=1; m.unit='unid'; }
        else {
          let currentRaw=0;
          if(m.type==='line'){ const a=toCanvas(m.start), b=toCanvas(m.end); currentRaw=distance(a,b); }
          else if(m.type==='poly'){ const pts=m.points.map(toCanvas); currentRaw=polygonAreaPx(pts); }
          const currentScale = baseScale * zoomLevel;
          if(m.type==='poly'){ m.value = currentRaw / Math.pow(currentScale, 2); }
          else { m.value = currentRaw / currentScale; }
          m.unit=currentUnit;
        }
      });
      document.getElementById('modal-scale').classList.remove('active');
      draw(); updateReportTable();
    }
  }

  function draw(){
    annCtx.clearRect(0,0,annCanvas.width,annCanvas.height); const nowPage=currentPage;
    
    measurements.filter(m => {
        if (m.page !== nowPage) return false;
        return isMeasurementVisible(m);
    }).forEach(m=>{
      annCtx.save(); annCtx.strokeStyle=m.color; annCtx.fillStyle=m.color+'33'; annCtx.lineWidth=2; annCtx.setLineDash([]);
      if(m.type==='pin'){ const s=toCanvas(m.start); annCtx.beginPath(); annCtx.arc(s.x,s.y,6,0,Math.PI*2); annCtx.fill(); annCtx.stroke(); }
      else if(m.type==='rect'){ const r=rectFromPoints(toCanvas(m.start),toCanvas(m.end)); annCtx.fillRect(r.x,r.y,r.w,r.h); annCtx.strokeRect(r.x,r.y,r.w,r.h); }
      else if(m.type==='line'){ const a=toCanvas(m.start), b=toCanvas(m.end); annCtx.beginPath(); annCtx.moveTo(a.x,a.y); annCtx.lineTo(b.x,b.y); annCtx.stroke(); }
      else if(m.type==='poly'){ if(m.points && m.points.length>=3){ annCtx.beginPath(); const p0=toCanvas(m.points[0]); annCtx.moveTo(p0.x,p0.y); for(let i=1;i<m.points.length;i++){ const pi=toCanvas(m.points[i]); annCtx.lineTo(pi.x,pi.y);} annCtx.closePath(); annCtx.fill(); annCtx.stroke(); } }
      annCtx.restore();
      if(selectedId===m.id){
        annCtx.save(); annCtx.strokeStyle='#6366f1'; annCtx.setLineDash([6,4]); annCtx.lineWidth=2;
        if(m.type==='pin'){ const s=toCanvas(m.start); annCtx.beginPath(); annCtx.arc(s.x,s.y,10,0,Math.PI*2); annCtx.stroke(); }
        else if(m.type==='rect'){ const r=rectFromPoints(toCanvas(m.start),toCanvas(m.end)); annCtx.strokeRect(r.x-4,r.y-4,r.w+8,r.h+8); }
        else if(m.type==='line'){ const a=toCanvas(m.start), b=toCanvas(m.end); annCtx.beginPath(); annCtx.moveTo(a.x,a.y); annCtx.lineTo(b.x,b.y); annCtx.stroke(); }
        else if(m.type==='poly'){ const p0=toCanvas(m.points[0]); annCtx.beginPath(); annCtx.moveTo(p0.x,p0.y); for(let i=1;i<m.points.length;i++){ const pi=toCanvas(m.points[i]); annCtx.lineTo(pi.x,pi.y);} annCtx.closePath(); annCtx.stroke(); }
        annCtx.restore();
      }
    });
  }

  function centroidOfMarkPx(m){ if(m.type==='pin'){ const s=toCanvas(m.start); return {x:s.x,y:s.y}; } if(m.type==='rect'){ const a=toCanvas(m.start), b=toCanvas(m.end); return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; } if(m.type==='line'){ const a=toCanvas(m.start), b=toCanvas(m.end); return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; } if(m.type==='poly'){ const pts=m.points.map(toCanvas); let cx=0, cy=0, A=0; for(let i=0,j=pts.length-1;i<pts.length;j=i++){ const f = pts[j].x*pts[i].y - pts[i].x*pts[j].y; A += f; cx += (pts[j].x + pts[i].x)*f; cy += (pts[j].y + pts[i].y)*f; } A = A/2; if(Math.abs(A) < 1e-6){ let sx=0, sy=0; pts.forEach(p=>{sx+=p.x; sy+=p.y;}); return {x:sx/pts.length, y:sy/pts.length}; } cx = cx/(6*A); cy = cy/(6*A); return {x:cx,y:cy}; } return {x:0,y:0}; }
  function placeCloneAt(pPx){ if(!cloneSource) return; const src = cloneSource; const newM = JSON.parse(JSON.stringify(src)); newM.id = Date.now(); newM.page = currentPage; const c = centroidOfMarkPx(src); const dx = pPx.x - c.x; const dy = pPx.y - c.y; function shiftPtNorm(pt){ const pp = toCanvas(pt); return fromCanvas({x:pp.x+dx, y:pp.y+dy}); } if(newM.type==='pin'){ newM.start = fromCanvas({x:pPx.x,y:pPx.y}); } else if(newM.type==='rect' || newM.type==='line'){ newM.start = shiftPtNorm(newM.start); newM.end = shiftPtNorm(newM.end); } else if(newM.type==='poly'){ newM.points = newM.points.map(shiftPtNorm); } if(newM.type==='pin' || newM.type==='rect'){ newM.value = 1; newM.unit='unid'; newM.raw=1; } else if(newM.type==='line'){ const a=toCanvas(newM.start), b=toCanvas(newM.end); newM.raw = distance(a,b); const currentScale = baseScale * zoomLevel; newM.value = baseScale>0 ? newM.raw / currentScale : 0; newM.unit=currentUnit; } else if(newM.type==='poly'){ const pts=newM.points.map(toCanvas); newM.raw = polygonAreaPx(pts); const currentScale = baseScale * zoomLevel; newM.value = baseScale>0 ? newM.raw / Math.pow(currentScale,2) : 0; newM.unit=currentUnit; } measurements.push(newM); selectedId = newM.id; draw(); updateReportTable(); }

  function updateReportTable(){
    const body = document.getElementById('db-body');
    body.innerHTML = measurements.map(m=>{
      const isCount = (m.type==='pin' || m.type==='rect' || !m.value);
      const qty = isCount ? ( '1 unid' ) : (Number(m.value||0).toFixed(2) + ' ' + (m.type==='poly' ? (m.unit+'²') : m.unit));
      const typeLabel = (m.type==='line'?'Medición':(m.type==='pin'?'Pin':(m.type==='rect'?'Rectángulo':'Polígono')));
      const isRevised = m.revised ? 'checked' : '';
      return `<tr>
        <td class="px-4 py-3 font-bold text-slate-700">${m.csi.div}</td>
        <td class="px-4 py-3 font-mono text-xs text-indigo-600 font-bold">${m.csi.sub}</td>
        <td class="px-4 py-3 text-sm text-slate-600">${m.csi.comm||''}</td>
        <td class="px-4 py-3 text-xs text-slate-500">Page ${m.page}</td>
        <td class="px-4 py-3"><span class="badge bg-slate-100 text-slate-700">${typeLabel}</span></td>
        <td class="px-4 py-3 text-right font-black">${qty}</td>
        <td class="px-4 py-3 text-center flex items-center gap-2 justify-center"><button onclick="openMarkEditor({...measurements.find(x=>x.id===${m.id})});" class="text-indigo-600 hover:text-indigo-700" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="removeMeasurement(${m.id})" class="text-red-500 hover:text-red-600" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
      </tr>`;
    }).join('');
    const groupBody = document.getElementById('group-body');
    const groups = new Map();
    for(const m of measurements){
      const key = JSON.stringify({ div:m.csi.div, sub:m.csi.sub, comm:m.csi.comm||'', type:m.type, color:m.color, unit:m.unit });
      const inc = (m.type==='pin' || m.type==='rect') ? 1 : Number(m.value||0);
      if(!groups.has(key)) groups.set(key,{ ...JSON.parse(key), total:0, count:0 });
      groups.get(key).total += inc; groups.get(key).count += 1;
    }
    const rows = [...groups.values()].map(g=>{
      const unitShow = (g.type==='poly') ? (g.unit+'²') : ( (g.type==='pin'||g.type==='rect') ? 'unid' : g.unit );
      const typeLabel = g.type==='line'?'Medición':(g.type==='pin'?'Pin':(g.type==='rect'?'Rectángulo':'Polígono'));
      const marksInGroup = measurements.filter(m => m.csi && m.csi.div === g.div && m.csi.sub === g.sub && (m.csi.comm || '') === (g.comm || ''));
      const allRevised = marksInGroup.length > 0 && marksInGroup.every(m => m.revised);
      const someRevised = marksInGroup.some(m => m.revised);
      const isChecked = allRevised ? 'checked' : '';
      const isPartial = someRevised && !allRevised ? 'data-partial="true"' : '';
      return `<tr>
        <td class="px-4 py-3 font-bold text-slate-700">${g.div}</td>
        <td class="px-4 py-3 font-mono text-xs text-indigo-600 font-bold">${g.sub}</td>
        <td class="px-4 py-3 text-sm text-slate-600">${g.comm||''}</td>
        <td class="px-4 py-3"><span class="badge bg-slate-100 text-slate-700">${typeLabel}</span></td>
        <td class="px-4 py-3"><span class="badge" style="background:${g.color}22;color:${g.color}">color</span></td>
        <td class="px-4 py-3 text-center"><input type="checkbox" class="group-revision-chk rounded border-slate-300 text-red-600" data-div="${g.div}" data-sub="${g.sub}" data-comm="${g.comm||''}" ${isChecked} ${isPartial} onchange="toggleGroupRevision(this)" title="Mark all items in this group as revised"></td>
        <td class="px-4 py-3 text-right font-black">${ ((g.type==='pin'||g.type==='rect') ? g.total.toFixed(0) : g.total.toFixed(2)) } ${unitShow}</td>
        <td class="px-4 py-3 text-right">${g.count}</td>
      </tr>`;
    }).join('');
    groupBody.innerHTML = rows || '<tr><td colspan="8" class="px-4 py-4 text-slate-400">Sin datos</td></tr>';
    lucide.createIcons();
  }
  function removeMeasurement(id){ saveUndoState(); measurements = measurements.filter(x=>x.id!==id); if(selectedId===id) selectedId=null; updateReportTable(); draw(); updateBrandPropertyDropdown(); updateRevisionNotes(); }
  function toggleGroupRevision(checkbox) {
    saveUndoState();
    const div = checkbox.dataset.div;
    const sub = checkbox.dataset.sub;
    const comm = checkbox.dataset.comm || '';
    const isChecked = checkbox.checked;
    const marksInGroup = measurements.filter(m => m.csi && m.csi.div === div && m.csi.sub === sub && (m.csi.comm || '') === comm);
    marksInGroup.forEach(m => {
      m.revised = isChecked;
    });
    updateRevisionNotes();
    updateReportTable();
  }
  function updateRevisionNotes(){ const revisedItems = measurements.filter(m => m.revised); const revisionNotesDiv = document.getElementById('revision-notes'); const revisionListDiv = document.getElementById('revision-items-list'); if(revisedItems.length > 0){ revisionNotesDiv.classList.remove('hidden'); revisionListDiv.innerHTML = revisedItems.map((m, idx) => `<li>${idx + 1}. ${m.csi.div} - ${m.csi.sub}: ${m.csi.comm || 'N/A'}</li>`).join(''); } else { revisionNotesDiv.classList.add('hidden'); } }

  function exportData(){
    const det = measurements.map(m=>({ Division:m.csi.div, Subdivision:m.csi.sub, Remarks:m.csi.comm, Type:m.type, Color:m.color, Quantity: (m.type==='pin'||m.type==='rect') ? 1 : Number(m.value||0), Unit: (m.type==='poly')? (m.unit+'²') : ((m.type==='pin'||m.type==='rect')?'unid':m.unit), Page:m.page }));
    const groups=[]; const map=new Map();
    for(const m of measurements){
      const key=JSON.stringify({div:m.csi.div,sub:m.csi.sub,comm:m.csi.comm||'',type:m.type,color:m.color,unit:m.unit});
      const inc=(m.type==='pin'||m.type==='rect')?1:Number(m.value||0);
      if(!map.has(key)) map.set(key,{...JSON.parse(key),total:0,count:0});
      const g=map.get(key); g.total+=inc; g.count+=1;
    }
    for(const v of map.values()){
      groups.push({ Division:v.div, Subdivision:v.sub, Remarks:v.comm, Type:v.type, Color:v.color, Total:(v.type==='pin'||v.type==='rect')?v.total: Number(v.total.toFixed(4)), Unit:(v.type==='poly')?(v.unit+'²'):((v.type==='pin'||v.type==='rect')?'unid':v.unit), Marks:v.count });
    }
    const wb=XLSX.utils.book_new(); const ws1=XLSX.utils.json_to_sheet(groups); const ws2=XLSX.utils.json_to_sheet(det); XLSX.utils.book_append_sheet(wb, ws1, 'Totals'); XLSX.utils.book_append_sheet(wb, ws2, 'Details'); XLSX.writeFile(wb,'CSI_Report.xlsx');
  }

  // ======= Suppliers Logic =======
  let activeSupplierId = null;
  let editingRequestId = null;

  function renderSuppliersView(){
    const list = document.getElementById('suppliers-list');
    if(suppliers.length === 0){
      list.innerHTML = '<div class="text-center text-slate-400 text-sm py-10">There are no registered suppliers.</div>';
    } else {
      list.innerHTML = suppliers.map(s => `
        <div onclick="openSupplierProfile(${s.id})" class="p-4 rounded-xl border cursor-pointer transition ${activeSupplierId===s.id ? 'bg-indigo-50 border-indigo-500 ring-1 ring-indigo-500' : 'bg-white border-slate-200 hover:border-indigo-300'}">
          <div class="font-bold text-slate-800">${s.name}</div>
          <div class="text-xs text-slate-500 mt-1 truncate">${s.contact || 'No contact available'}</div>
        </div>
      `).join('');
    }
    renderSupplierDetail();
  }

  function selectSupplier(id){ activeSupplierId = id; renderSuppliersView(); }

  function renderSupplierDetail(){
    const empty = document.getElementById('supplier-detail-empty');
    const content = document.getElementById('supplier-detail-content');
    if(!activeSupplierId){ empty.classList.remove('hidden'); content.classList.add('hidden'); content.classList.remove('flex'); return; }
    const s = suppliers.find(x=>x.id===activeSupplierId);
    if(!s) return;
    empty.classList.add('hidden'); content.classList.remove('hidden'); content.classList.add('flex');
    document.getElementById('detail-name').textContent = s.name;
    document.getElementById('detail-contact').innerHTML = `<i data-lucide="user" class="w-4 h-4"></i> <span>${s.contact||'--'}</span>`;
    document.getElementById('detail-email').innerHTML = `<i data-lucide="mail" class="w-4 h-4"></i> <span>${s.email||'--'}</span>`;
    const reqs = supplierRequests.filter(r => r.supplierId === activeSupplierId).sort((a,b)=>b.date - a.date);
    const reqList = document.getElementById('requests-list');
    if(reqs.length === 0){
      reqList.innerHTML = '<div class="text-sm text-slate-400 italic">There are no requests created for this supplier.</div>';
    } else {
      reqList.innerHTML = reqs.map(r => {
        const dateStr = new Date(r.date).toLocaleDateString();
        const pageCount = r.pages.length;
        const itemCount = r.items.length;
        return `
          <div class="bg-white border rounded-xl p-4 shadow-sm">
            <div class="flex justify-between items-start mb-2">
              <div><span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Request #${String(r.id).slice(-4)}</span> <span class="text-xs text-slate-400 ml-2">${dateStr}</span></div>
              <div class="flex items-center gap-2">
                <button class="text-slate-600 hover:text-slate-800" title="Editar" onclick="openRequestEditModal(${r.id})"><i data-lucide="square-pen" class="w-4 h-4"></i></button>
                <button class="text-slate-600 hover:text-slate-800" title="Imprimir" onclick="printRequest(${r.id})"><i data-lucide="printer" class="w-4 h-4"></i></button>
                <button class="text-red-600 hover:text-red-700" title="Eliminar" onclick="deleteRequest(${r.id})"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
            </div>
            <div class="text-sm text-slate-600 mb-2"><b>Pages sent:</b> ${pageCount > 0 ? r.pages.join(', ') : 'None'}</div>
            <div class="text-xs font-bold text-slate-500">${itemCount} Ítems</div>
            ${r.notes ? `<div class="text-xs text-slate-400 bg-slate-50 p-2 rounded italic mt-2">"${r.notes}"</div>` : ''}
          </div>
        `;
      }).join('');
    }
    lucide.createIcons();
  }

  function openSupplierModal(){ document.getElementById('modal-supplier').classList.add('active'); document.getElementById('sup-name').value=''; document.getElementById('sup-contact').value=''; document.getElementById('sup-email').value=''; document.getElementById('sup-phone').value=''; }

  function saveSupplier(){
    const name = document.getElementById('sup-name').value.trim();
    if(!name){ alertMsg('Name is required'); return; }
    const s = { id: Date.now(), name, contact: document.getElementById('sup-contact').value, email: document.getElementById('sup-email').value, phone: document.getElementById('sup-phone').value };
    suppliers.push(s); activeSupplierId = s.id; document.getElementById('modal-supplier').classList.remove('active'); renderSuppliersView(); clearAlert();
  }

  function openSupplierProfile(id){
    activeSupplierId = id;
    const s = suppliers.find(x=>x.id===id);
    if(!s) return;
    document.getElementById('edit-sup-name').value = s.name||'';
    document.getElementById('edit-sup-contact').value = s.contact||'';
    document.getElementById('edit-sup-email').value = s.email||'';
    document.getElementById('edit-sup-phone').value = s.phone||'';
    document.getElementById('modal-supplier-profile').classList.add('active');
    renderSuppliersView();
  }

  function updateSupplier(){
    const s = suppliers.find(x=>x.id===activeSupplierId);
    if(!s) return;
    s.name = document.getElementById('edit-sup-name').value.trim();
    s.contact = document.getElementById('edit-sup-contact').value.trim();
    s.email = document.getElementById('edit-sup-email').value.trim();
    s.phone = document.getElementById('edit-sup-phone').value.trim();
    document.getElementById('modal-supplier-profile').classList.remove('active');
    renderSuppliersView();
  }

  function deleteSupplier(id){
    if(!id) return;
    if(!confirm('Remove this supplier and ALL their requests?')) return;
    suppliers = suppliers.filter(s=>s.id!==id);
    supplierRequests = supplierRequests.filter(r=>r.supplierId!==id);
    activeSupplierId = null;
    document.getElementById('modal-supplier-profile').classList.remove('active');
    renderSuppliersView();
  }

  // ===== Solicitudes (Crear / Editar) =====
  function closeRequestModal(){ document.getElementById('modal-request').classList.remove('active'); editingRequestId = null; }
  function toggleAllReqItems(cb){ document.querySelectorAll('.req-item-chk').forEach(c => { c.checked = cb.checked; c.dispatchEvent(new Event('change')); }); }
  function toggleAllReqDivisions(checked) {
    document.querySelectorAll('.req-division-chk').forEach(chk => { chk.checked = checked; });
    updateReqTableFromDivisions();
  }
  function toggleReqDetail(){ document.getElementById('req-detail-list').classList.toggle('hidden'); }

  function buildRequestModal(preset){
    // Title & mode
    const title = document.getElementById('req-modal-title');
    const btn = document.getElementById('req-save-btn');
    const isEdit = !!preset;
    title.textContent = isEdit ? 'Edit Quote Request' : 'Create Quote Request';
    btn.textContent = isEdit ? 'Save Changes' : 'Create Request';

    // Render Pages with Sheet Identifications
    const pgCont = document.getElementById('req-pages-container');
    const totalPages = pdfDoc ? pdfDoc.numPages : 0;
    if(totalPages===0) pgCont.innerHTML = '<span class="col-span-8 text-xs text-red-400">Load a PDF first</span>';
    else {
      let html = '';
      const projName = document.getElementById('project-name').value.trim();
      for(let i=1; i<=totalPages; i++){
        const chk = preset && preset.pages ? preset.pages.includes(String(i)) || preset.pages.includes(i) : false;
        const sheetId = projName ? localStorage.getItem(`sheet-id-${projName}-page-${i}`) || '' : localStorage.getItem(`sheet-id-page-${i}`) || sheetIdentifications[i] || '';
        const displayLabel = sheetId ? sheetId : String(i);
        const tooltipText = sheetId ? `Page ${i}: ${sheetId}` : `Page ${i}`;
        html += `<label class="flex items-center justify-center gap-1 border rounded p-2 cursor-pointer hover:bg-indigo-50 select-none" title="${tooltipText}">
          <input type="checkbox" value="${i}" class="req-page-chk accent-indigo-600" ${chk?'checked':''}>
          <span class="text-xs font-bold text-slate-600">${displayLabel}</span>
        </label>`;
      }
      pgCont.innerHTML = html;
    }

    // Render Detail List (CSI Divisions)
    const detailList = document.getElementById('req-detail-list');
    const projectDivisions = new Map();
    measurements.forEach(m => {
        if (m.csi && m.csi.div && !projectDivisions.has(m.csi.div)) {
            const divName = CSI_TITLES[m.csi.div] || (csiDivMap.get(m.csi.div)?.name) || `Division ${m.csi.div}`;
            projectDivisions.set(m.csi.div, divName);
        }
    });

    if(projectDivisions.size === 0){
        detailList.innerHTML = '<div class="p-2 text-xs text-slate-400">No items with CSI divisions found in project.</div>';
    } else {
        let detailHtml = `<div class="flex items-center gap-4 p-1 border-b mb-1">
          <label class="flex items-center gap-2 text-xs font-bold cursor-pointer"><input type="checkbox" onchange="toggleAllReqDivisions(this.checked)" checked> Select/Deselect All</label>
        </div>`;
        const sortedDivisions = [...projectDivisions.entries()].sort((a, b) => a[0].localeCompare(b[0]));

        detailHtml += sortedDivisions.map(([divCode, divName]) => {
            const isChecked = preset && preset.selectedDivisions ? preset.selectedDivisions.includes(divCode) : true;
            return `<label class="flex items-center gap-2 p-1 hover:bg-white rounded cursor-pointer border-b border-slate-100 last:border-0">
                <input type="checkbox" value="${divCode}" class="req-division-chk rounded border-slate-300 text-indigo-600" ${isChecked?'checked':''} onchange="updateReqTableFromDivisions()">
                <div class="flex-1 flex justify-between items-center">
                  <span class="text-[10px] font-bold text-slate-600 truncate max-w-[400px]">${divCode} - ${divName}</span>
                </div>
            </label>`;
        }).join('');
        detailList.innerHTML = detailHtml;
    }

    document.getElementById('req-notes').value = preset && preset.notes ? preset.notes : '';
    updateReqTableFromDivisions(preset ? preset.items : null);
  }

  function updateReqTableFromDivisions(presetItems = null){
    const selectedDivs = [...document.querySelectorAll('.req-division-chk:checked')].map(cb => cb.value);
    const selectedMs = measurements.filter(m => selectedDivs.includes(m.csi.div));
    
    // 3. Agrupar para la tabla
    const groups = new Map();
    for(const m of selectedMs){
      const key = JSON.stringify({ div:m.csi.div, sub:m.csi.sub, comm: m.csi.comm || '' });
      const inc = (m.type==='pin' || m.type==='rect') ? 1 : Number(m.value||0);
      if(!groups.has(key)) groups.set(key,{ ...JSON.parse(key), total:0, unit: (m.type==='poly' ? m.unit+'²' : (m.type==='pin'||m.type==='rect'?'unid':m.unit)) });
      groups.get(key).total += inc;
    }

    // 4. Renderizar tabla
    const tbody = document.getElementById('req-items-body');
    const presetMap = new Map();
    if(presetItems){ presetItems.forEach(it=>{ presetMap.set(`${it.div}|${it.sub}|${it.comm || ''}`, it); }); }

    const rows = [...groups.values()];
    tbody.innerHTML = rows.map(g=>{
      const key = `${g.div}|${g.sub}|${g.comm || ''}`;
      const was = presetMap.get(key);
      const checked = presetItems ? !!was : true;
      const qtyVal = was ? Number(was.qty||was.total||g.total).toFixed(2) : Number(g.total).toFixed(2);
      
      return `
        <tr>
          <td class="px-4 py-2">
            <input type="checkbox" class="req-item-chk rounded border-slate-300 text-indigo-600" data-key="${key}" data-unit="${g.unit}" data-total="${g.total}" ${checked?'checked':''}>
          </td>
          <td class="px-4 py-2 text-xs font-bold text-slate-700">${g.div}</td>
          <td class="px-4 py-2 text-xs text-indigo-600 font-mono">${g.sub}</td>
          <td class="px-4 py-2 text-xs text-slate-500 truncate max-w-xs">${g.comm}</td>
          <td class="px-4 py-2 text-xs font-bold text-right">${Number(g.total).toFixed(2)} ${g.unit}</td>
          <td class="px-4 py-2 text-xs text-right">
            <input type="number" step="0.01" min="0" class="req-qty w-24 bg-white border rounded-lg px-2 py-1 text-right" data-key="${key}" value="${qtyVal}" ${checked?'':'disabled'}>
            <span class="ml-1 text-[11px] text-slate-500">${g.unit}</span>
          </td>
        </tr>
      `;
    }).join('') || '<tr><td colspan="6" class="p-4 text-center text-xs text-slate-400">No items found for selected divisions.</td></tr>';

    // Hook listeners
    document.querySelectorAll('.req-item-chk').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const key=chk.dataset.key;
        const qtyInput = document.querySelector(`.req-qty[data-key="${key}"]`);
        if(qtyInput){ qtyInput.disabled = !chk.checked; if(chk.checked && !qtyInput.value){ qtyInput.value = Number(chk.dataset.total||0).toFixed(2); } }
      });
    });
  }

  function openRequestModal(){
    if(!activeSupplierId) return;
    editingRequestId = null;
    document.getElementById('modal-request').classList.add('active');
    buildRequestModal(null);
    lucide.createIcons();
  }

  function openRequestEditModal(id){
    const r = supplierRequests.find(x=>x.id===id && x.supplierId===activeSupplierId);
    if(!r) return;
    editingRequestId = id;
    document.getElementById('modal-request').classList.add('active');

    let selectedDivisions = r.selectedDivs;
    if (!selectedDivisions && r.items && r.items.length > 0) {
        selectedDivisions = [...new Set(r.items.map(item => item.div))];
    }

    const preset = { pages: r.pages || [], items: r.items || [], notes: r.notes||'', selectedDivisions };
    buildRequestModal(preset);
    lucide.createIcons();
  }

  function collectRequestFromModal(){
    const pages = [...document.querySelectorAll('.req-page-chk:checked')].map(c=>c.value);
    const items = [...document.querySelectorAll('.req-item-chk:checked')].map(chk=>{
      const key = chk.dataset.key; const [div,sub, ...commParts] = key.split('|');
      let comm = commParts.join('|');
      const unit = chk.dataset.unit;
      const total = Number(chk.dataset.total||0);
      const qtyInput = document.querySelector(`.req-qty[data-key="${key}"]`);
      const qty = Number(qtyInput && qtyInput.value ? qtyInput.value : total);
      const measurement = measurements.find(m => m.csi.div === div && m.csi.sub === sub && (m.csi.comm || '') === comm);
      if(measurement) comm = measurement.csi.comm || comm;
      const revised = measurement && measurement.revised ? true : false;
      return { div, sub, comm, unit, total, qty, revised };
    });
    const notes = document.getElementById('req-notes').value;
    const selectedDivs = [...document.querySelectorAll('.req-division-chk:checked')].map(c=>c.value);
    
    // Collect sheet identifications from localStorage (already saved in Editor)
    const sheetIds = {};
    const projName = document.getElementById('project-name').value.trim();
    if(pdfDoc) {
      for(let i=1; i<=pdfDoc.numPages; i++){
        const sheetId = projName ? localStorage.getItem(`sheet-id-${projName}-page-${i}`) : localStorage.getItem(`sheet-id-page-${i}`);
        if(sheetId) {
          sheetIds[i] = sheetId;
        }
      }
    }
    
    if(items.length===0 && pages.length===0){ alertMsg('Select at least one page or item.'); return null; }
    return { pages, items, notes, selectedDivs, sheetIds };
  }

  function saveRequest(){
    const data = collectRequestFromModal(); if(!data) return;
    if(editingRequestId){
      const idx = supplierRequests.findIndex(r=>r.id===editingRequestId && r.supplierId===activeSupplierId);
      if(idx>=0){
        supplierRequests[idx].pages = data.pages;
        supplierRequests[idx].items = data.items;
        supplierRequests[idx].notes = data.notes;
        supplierRequests[idx].sheetIds = data.sheetIds;
        supplierRequests[idx].selectedDivs = data.selectedDivs;
        supplierRequests[idx].date = Date.now(); // actualización
        delete supplierRequests[idx].measurementIds;
      }
    } else {
      supplierRequests.push({ id: Date.now(), supplierId: activeSupplierId, date: Date.now(), pages: data.pages, items: data.items, notes: data.notes, selectedDivs: data.selectedDivs, sheetIds: data.sheetIds });
    }
    closeRequestModal();
    renderSupplierDetail();
    clearAlert();
  }

  function deleteRequest(id){
    if(!confirm('Do you want to delete this request?')) return;
    supplierRequests = supplierRequests.filter(r=>r.id!==id);
    renderSupplierDetail();
  }

  function printRequest(id){
    const r = supplierRequests.find(x=>x.id===id);
    if(!r){ alertMsg('Request not found.'); return; }
    const w = window.open('', '_blank');
    if(!w){ alertMsg('Browser blocked the popup. Please allow it to print.'); return; }
    
    const projName = document.getElementById('project-name').value || 'Project';
    const printDate = new Date().toLocaleString();
    const sup = suppliers.find(s=>s.id===r.supplierId) || {};
    const requesterName = document.getElementById('requester-name')?.textContent || localStorage.getItem('requesterName') || 'Unknown';
    let pagesHtml = '';
    if (r.pages && r.pages.length) {
      pagesHtml = r.pages.map(p => {
        const sheetId = r.sheetIds && r.sheetIds[p] ? r.sheetIds[p] : '';
        return sheetId ? `${p} (${sheetId})` : p;
      }).join(', ');
    } else {
      pagesHtml = '—';
    }
    const itemsRows = (r.items||[]).map((it, idx)=>`
      <tr>
        <td style="padding: 8px 12px; font-weight: bold;">${idx + 1}${it.revised ? ' <span style="color: #dc2626; font-weight: bold;">R</span>' : ''}</td>
        <td style="padding: 8px 12px; font-family: monospace; font-size: 12px; color: #4338ca;">${it.sub}</td>
        <td style="padding: 8px 12px; font-size: 12px;">${it.comm || ''}</td>
        <td style="padding: 8px 12px; text-align: right; font-weight: bold;">${Number(it.qty||0).toFixed(2)} <span style="color:#64748b;">${it.unit||''}</span></td>
      </tr>
    `).join('') || `<tr><td colspan="4" style="padding: 24px 12px; text-align: center; color: #94a3b8; font-size: 14px;">Sin ítems seleccionados</td></tr>`;
    
    // Prepare revised items notice
    const revisedItems = (r.items||[]).filter(it => it.revised);
    const revisionNoticeHtml = revisedItems.length > 0 ? `
      <div class="card" style="padding:12px;margin-top:12px;background:#fee2e2;border:1px solid #fecaca">
        <div style="color:#991b1b;font-weight:bold;margin-bottom:8px;">Revised Items Notice</div>
        <div style="color:#7f1d1d;font-size:11px;margin-bottom:8px;">The following items marked with <span style="color:#dc2626;font-weight:bold;">(R)</span> have been revised from their original submission and contain new descriptions or specifications:</div>
        <ul style="color:#7f1d1d;font-size:11px;margin:0;padding-left:20px;">
          ${revisedItems.map((it, idx) => `<li>${idx + 1}. ${it.div} - ${it.sub}: ${it.comm || 'N/A'}</li>`).join('')}
        </ul>
      </div>
    ` : '';

    w.document.open();
    w.document.write(`
      <html><head><title>Request #${String(r.id).slice(-4)}</title>
      <style>
        @page { size: 8.1in 11in; margin: 0.5in; }
        body { font-family: 'Plus Jakarta Sans', Arial, sans-serif; color:#0f172a; }
        .h1 { font-size:20px; font-weight:800; margin:0; }
        .muted { color:#64748b; }
        .card { border:1px solid #e2e8f0; border-radius:12px; }
        table { width:100%; border-collapse: collapse; }
        th, td { border-bottom:1px solid #e2e8f0; text-align: left; }
        .badge { display:inline-block; padding:2px 8px; border-radius:9999px; background:#e0e7ff; color:#3730a3; font-weight:700; font-size:10px; }
        .meta { font-size:12px; }
        .mb-1{margin-bottom:4px}.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}.mb-4{margin-bottom:16px}.mb-6{margin-bottom:24px}
      </style></head>
      <body>
        <div class="mb-6">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
            <div>
              <div class="h1">Request for Quotation <span class="badge">#${String(r.id).slice(-4)}</span></div>
              <div class="meta muted">Requester: <b>${requesterName}</b></div>
              <div class="meta muted">Project: <b>${projName}</b></div>
              <div class="meta muted">Print Date: ${printDate}</div>
            </div>
            <div style="text-align:right">
              <div class="meta"><b>Supplier:</b> ${sup.name||'—'}</div>
              <div class="meta">Contact Person: ${sup.contact||'—'}</div>
              <div class="meta">Email: ${sup.email||'—'}</div>
              <div class="meta">Tel: ${sup.phone||'—'}</div>
            </div>
          </div>
        </div>

        <div class="mb-4 card" style="padding:12px">
          <div class="meta"><b>Sheet Identification:</b> ${pagesHtml}</div>
        </div>

        <div class="card">
          <table>
            <thead style="background:#f8fafc">
              <tr>
                <th style="padding: 8px 12px; font-size:12px">ITEM</th>
                <th style="padding: 8px 12px; font-size:12px">Subdivisión</th>
                <th style="padding: 8px 12px; font-size:12px">Remarks</th>
                <th style="padding: 8px 12px; font-size:12px; text-align:right;">Requested Quantity</th>
              </tr>
            </thead>
            <tbody>
              ${itemsRows}
            </tbody>
          </table>
        </div>

        ${r.notes ? `<div class="card" style="padding:12px;margin-top:12px"><div class="meta muted"><b>Notas:</b> ${r.notes}</div></div>` : ''}

        ${revisionNoticeHtml}

        <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
          <img src="https://storage.googleapis.com/permisos-takeoff/takeoffly%20Logo.png" alt="Takeoffly Logo" style="max-width:150px;height:auto;margin:auto;display:block;">
        </footer>

        <script>window.onload = function(){ setTimeout(()=>window.print(), 100); }<\/script>
      </body></html>
    `);
    w.document.close();
  }

  // ===== Proyecto: Guardar SIEMPRE con PDF + Recuperar =====
  function uint8ToBase64(u8){ let CHUNK_SIZE = 0x8000; let index = 0; const length = u8.length; let result = ''; while(index < length){ const slice = u8.subarray(index, Math.min(index + CHUNK_SIZE, length)); result += String.fromCharCode.apply(null, slice); index += CHUNK_SIZE; } return btoa(result); }
  function base64ToUint8(b64){ const binary = atob(b64); const len = binary.length; const bytes = new Uint8Array(len); for(let i=0;i<len;i++){ bytes[i] = binary.charCodeAt(i); } return bytes; }

  async function saveProject(){
    if(!window._originalPdfBytes){ alertMsg('No PDF loaded. Project MUST include PDF for automatic recovery.'); return false; }
    const pname = document.getElementById('project-name').value.trim();
    const pstart = document.getElementById('project-start').value;
    if(!pname){ alertMsg('Enter the project name.'); return false; }
    if(!pstart){ alertMsg('Select the start date.'); return false; }
    clearAlert();
    const safe = sanitizeName(pname);
    const key = 'refCounter_'+safe.toLowerCase();
    let n = parseInt(localStorage.getItem(key)||'0',10) + 1; localStorage.setItem(key, String(n));
    const ref = String(n).padStart(3,'0');
    const savedAt = new Date();
    const savedDate = savedAt.toISOString().slice(0,10);
    const sheetIdentifications = {};
    if(pdfDoc){
      for(let i=1; i<=pdfDoc.numPages; i++){
        const sheetId = localStorage.getItem(`sheet-id-${pname}-page-${i}`);
        if(sheetId) sheetIdentifications[i] = sheetId;
      }
    }
    const project = {
      version: 11,
      meta: { projectName: pname, projectStart: pstart, savedAt: savedAt.toISOString(), saveRef: ref, appVersion: '15' },
      baseScale, currentUnit, measurements, lastCSIProps,
      suppliers, supplierRequests,
      sheetIdentifications,
      repeatProps: localStorage.getItem('repeatProps')==='1',
      pdfName: window._originalPdfName || 'Plano.pdf',
      pdf: uint8ToBase64(window._originalPdfBytes)
    };
    document.getElementById('footer-proj').textContent = pname;
    document.getElementById('footer-start').textContent = pstart;
    
    const blob = new Blob([JSON.stringify(project, null, 2)], {type: 'application/json'});
    const fileName = `CSI_${safe}_${savedDate}_ref-${ref}.json`;

    if (window.showSaveFilePicker) {
        try {
            const handle = await window.showSaveFilePicker({
                suggestedName: fileName,
                types: [{ description: 'JSON Project File', accept: { 'application/json': ['.json'] } }],
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            return true;
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error(err.name, err.message);
                alertMsg('Unable to save file.');
            }
            return false;
        }
    } else {
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName;
        document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
        return true;
    }
  }

  // ===== Full Screen Toggle Function =====
  function toggleFullScreen(){
    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  }

  async function confirmExit(save){
    document.getElementById('modal-exit-program').classList.remove('active');
    if(save){
      const success = await saveProject();
      if(success) window.close();
    } else {
      window.close();
    }
  }

  async function loadProjectFromFile(evt){
    const file = evt.target.files[0]; evt.target.value=''; if(!file) return;
    try{
      const text = await file.text();
      const proj = JSON.parse(text);
      baseScale = Number(proj.baseScale||0); currentUnit = proj.currentUnit || currentUnit; measurements = Array.isArray(proj.measurements)? proj.measurements : []; lastCSIProps = proj.lastCSIProps || null; localStorage.setItem('repeatProps', proj.repeatProps ? '1':'0');
      suppliers = Array.isArray(proj.suppliers) ? proj.suppliers : [];
      supplierRequests = Array.isArray(proj.supplierRequests) ? proj.supplierRequests : [];
      const meta = proj.meta || {};
      const projectName = meta.projectName || '';
      document.getElementById('project-name').value = projectName;
      document.getElementById('project-start').value = meta.projectStart || '';
      if(proj.sheetIdentifications && projectName){
        Object.entries(proj.sheetIdentifications).forEach(([page, id]) => {
          localStorage.setItem(`sheet-id-${projectName}-page-${page}`, id);
        });
      }
      document.getElementById('footer-proj').textContent = meta.projectName || '—';
      document.getElementById('footer-start').textContent = meta.projectStart || '—';
      if(proj.pdf){
        const bytes = base64ToUint8(proj.pdf);
        window._originalPdfBytes = bytes;
        window._originalPdfName = proj.pdfName || 'Proyecto.pdf';
        pdfDoc = await pdfjsLib.getDocument(bytes).promise;
        currentPage = 1; zoomLevel=1.0; await renderPage(1);
      } else {
        alertMsg('This project file does not include the PDF. Cannot restore view automatically.');
      }
      updateReportTable(); draw(); if(baseScale>0){ const st=document.getElementById('scale-status'); st.textContent=`Scale: 1 ${currentUnit} = ${baseScale.toFixed(2)} px (Base)`; st.className='text-[11px] font-black text-emerald-600 uppercase tracking-tighter ml-1'; st.classList.remove('hidden'); }
      renderSuppliersView();
      updateBrandPropertyDropdown(); // Now populates from measurements
      lucide.createIcons();
    } catch(err){ console.error(err); alertMsg('Unable to open project. Verify that the file is valid JSON.'); }
  }

  function showTooltip(pPx, m){ if(!isMeasurementVisible(m)){ hideTooltip(); return; } const isCount=(m.type==='pin'||m.type==='rect'); const unitShow = (m.type==='poly')?(m.unit+'²'):( isCount ? 'unid' : m.unit ); const typeLabel=m.type==='line'?'Medición':(m.type==='pin'?'Pin':(m.type==='rect'?'Rectángulo':'Polígono')); tooltip.style.left=(pPx.x+20)+'px'; tooltip.style.top=(pPx.y+20)+'px'; tooltip.style.display='block'; const val = isCount ? '1' : Number(m.value||0).toFixed(2); tooltip.innerHTML = `<div class='font-bold text-xs mb-1'>${typeLabel}</div><div class='text-xs'><span class='text-slate-400'>Div:</span> ${m.csi.div}</div><div class='text-xs'><span class='text-slate-400'>Sub:</span> ${m.csi.sub}</div>${m.csi.comm?`<div class='text-xs'><span class='text-slate-400'>Remarks:</span> ${m.csi.comm}</div>`:''}<div class='text-xs'><span class='text-slate-400'>Valor:</span> <b>${val} ${unitShow}</b></div>`; }
  function hideTooltip(){ tooltip.style.display='none'; }

  // ======= Funciones de UI Auxiliares =======
  function updateBrandPropertyDropdown(){
    const sel = document.getElementById('prop-preset');
    const existingProps = new Map();
    measurements.forEach(m => {
        const key = `${m.csi.div}|${m.csi.sub}|${m.csi.comm || ''}|${m.color}`;
        if (!existingProps.has(key)) {
            existingProps.set(key, { csi: m.csi, color: m.color, id: m.id });
        }
    });

    sel.innerHTML = '<option value="">Previous Marks...</option>';
    existingProps.forEach((prop, key) => {
        const label = `${prop.csi.comm || 'No comment'}`;
        const bgColor = prop.color;
        const textColor = isDark(bgColor) ? '#FFFFFF' : '#111827';
        sel.innerHTML += `<option value="${prop.id}" style="background-color:${bgColor}; color: ${textColor};">${label}</option>`;
    });
  }

  function applyBrandPropertyPreset(markId){
    const mark = measurements.find(m => m.id === markId);
    if(!mark) return;
    
    document.getElementById('prop-color').value = mark.color;
    lastCSIProps = { ...mark.csi };
    document.getElementById('repeat-props').checked = true;
    localStorage.setItem('repeatProps', '1');
    alertMsg(`Mark properties #${String(mark.id).slice(-4)} applied.`);
  }

  function openVisibilityControl() {
    const list = $('#visibility-list');
    const groups = new Map();
    const currentPageMeasurements = measurements.filter(m => !m.page || m.page === currentPage);
    currentPageMeasurements.forEach(m => {
        const key = `${m.csi.div} - ${m.csi.sub} - ${m.csi.comm || 'N/A'}`;
        if (!groups.has(key)) groups.set(key, { count: 0, color: m.color, ids: [] });
        groups.get(key).count++;
        groups.get(key).ids.push(m.id);
    });

    if (visibilityFilters.size === 0 && currentPageMeasurements.length > 0) {
        groups.forEach((_, key) => {
          const filterKey = `page${currentPage}_${key}`;
          visibilityFilters.set(filterKey, true);
        });
    }

    list.innerHTML = '';
    [...groups.entries()].sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, data]) => {
        const filterKey = `page${currentPage}_${key}`;
        const isVisible = visibilityFilters.get(filterKey) !== false;
        list.innerHTML += `
            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 cursor-pointer">
                <input type="checkbox" data-key="${filterKey}" class="vis-chk h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${isVisible ? 'checked' : ''}>
                <span class="w-4 h-4 rounded-full" style="background-color:${data.color}"></span>
                <span class="flex-1 text-sm font-medium text-slate-700">${key}</span>
                <span class="text-xs text-slate-400">${data.count} marks</span>
            </label>
        `;
    });

    $('#modal-visibility').classList.add('active');
  }

  function toggleAllVisibility(select) {
    document.querySelectorAll('.vis-chk').forEach(chk => chk.checked = select);
  }

  function applyVisibility() {
    document.querySelectorAll('.vis-chk').forEach(chk => {
        visibilityFilters.set(chk.dataset.key, chk.checked);
    });
    $('#modal-visibility').classList.remove('active');
    draw();
  }

  function getVisibilityKey(measurement) {
    const page = measurement.page || 1;
    const key = `${measurement.csi.div} - ${measurement.csi.sub} - ${measurement.csi.comm || 'N/A'}`;
    return `page${page}_${key}`;
  }

  function isMeasurementVisible(measurement) {
    const key = getVisibilityKey(measurement);
    return visibilityFilters.size === 0 || visibilityFilters.get(key) !== false;
  }

  // ======= Subtract Area Functions =======
  let subtractTargetMark = null;

  function openSubtractAreaModal(mark) {
    subtractTargetMark = mark;
    const modal = document.getElementById('modal-subtract-area');
    const currentDisplay = document.getElementById('current-area-display');
    const subtractInput = document.getElementById('subtract-amount');
    const resultDisplay = document.getElementById('result-area-display');
    const unitDisplay = document.getElementById('subtract-unit');
    
    const isCount = (mark.type === 'pin' || mark.type === 'rect');
    const currentValue = isCount ? 1 : Number(mark.value || 0);
    const unitText = (mark.type === 'poly') ? (mark.unit + '²') : (isCount ? 'unid' : mark.unit);
    
    unitDisplay.textContent = unitText;
    currentDisplay.textContent = currentValue.toFixed(2) + ' ' + unitText;
    subtractInput.value = '';
    resultDisplay.textContent = '—';
    
    subtractInput.addEventListener('input', updateSubtractPreview);
    modal.classList.add('active');
  }

  function updateSubtractPreview() {
    if (!subtractTargetMark) return;
    const subtractInput = document.getElementById('subtract-amount');
    const resultDisplay = document.getElementById('result-area-display');
    const unitDisplay = document.getElementById('subtract-unit');
    const currentDisplay = document.getElementById('current-area-display');
    
    const subtractAmount = parseFloat(subtractInput.value) || 0;
    const isCount = (subtractTargetMark.type === 'pin' || subtractTargetMark.type === 'rect');
    const currentValue = isCount ? 1 : Number(subtractTargetMark.value || 0);
    const resultValue = Math.max(0, currentValue - subtractAmount);
    const unitText = unitDisplay.textContent;
    
    resultDisplay.textContent = resultValue.toFixed(2) + ' ' + unitText;
    resultDisplay.style.color = resultValue < 0 ? '#dc2626' : '#6366f1';
  }

  function closeSubtractAreaModal() {
    document.getElementById('modal-subtract-area').classList.remove('active');
    subtractTargetMark = null;
    const subtractInput = document.getElementById('subtract-amount');
    subtractInput.removeEventListener('input', updateSubtractPreview);
  }

  function applySubtraction() {
    if (!subtractTargetMark) return;
    const subtractAmount = parseFloat(document.getElementById('subtract-amount').value) || 0;
    if (subtractAmount <= 0) {
      alertMsg('Enter a valid amount to subtract.');
      return;
    }
    
    saveUndoState();
    const isCount = (subtractTargetMark.type === 'pin' || subtractTargetMark.type === 'rect');
    const currentValue = isCount ? 1 : Number(subtractTargetMark.value || 0);
    const newValue = Math.max(0, currentValue - subtractAmount);
    
    subtractTargetMark.value = newValue;
    if (newValue === 0 && isCount) {
      subtractTargetMark.value = 0;
    }
    
    closeSubtractAreaModal();
    updateReportTable();
    draw();
    alertMsg(`Subtracted ${subtractAmount} ${subtractTargetMark.unit}. New value: ${newValue.toFixed(2)}`);
    setTimeout(clearAlert, 2500);
  }

  // ======= Integrate Projects Function =======
  function integrateProject(){
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'application/json';
    
    input.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if(files.length === 0) return;
      if(files.length > 10){ alertMsg('Maximum 10 files'); return; }
      
      try{
        let totalMeasurements = 0;
        let totalSuppliers = 0;
        let totalRequests = 0;
        
        for(const file of files){
          const text = await file.text();
          const proj = JSON.parse(text);
          
          // Integrate measurements
          if(Array.isArray(proj.measurements)){
            measurements = [...measurements, ...proj.measurements];
            totalMeasurements += proj.measurements.length;
          }
          
          // Integrate suppliers (avoid duplicates by email)
          if(Array.isArray(proj.suppliers)){
            const existingEmails = new Set(suppliers.map(s => s.email));
            proj.suppliers.forEach(s => {
              if(!existingEmails.has(s.email)){
                suppliers.push(s);
                totalSuppliers++;
              }
            });
          }
          
          // Integrate requests
          if(Array.isArray(proj.supplierRequests)){
            supplierRequests = [...supplierRequests, ...proj.supplierRequests];
            totalRequests += proj.supplierRequests.length;
          }
          
        }
        
        updateBrandPropertyDropdown();
        renderSuppliersView();
        updateReportTable();
        draw();
        
        alertMsg(`Successful integration: ${totalMeasurements} measurements, ${totalSuppliers} suppliers, ${totalRequests} requests`);
      } catch(err){
        console.error(err);
        alertMsg('Integration error. Verify files are valid.');
      }
    });
    
    input.click();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    lucide.createIcons();
    updateUndoRedoButtons();
    
    // Inicializar Requester
    const requesterDisplay = document.getElementById('requester-display');
    const requesterNameEl = document.getElementById('requester-name');
    if(requesterDisplay && requesterNameEl && requesterName && requesterName !== 'Unknown User') {
      requesterNameEl.textContent = requesterName;
      requesterDisplay.style.display = 'block';
    }
    
    fetchCSIData();
    document.getElementById('btn-refresh-db').addEventListener('click',()=>fetchCSIData(0,true));
    const rpStored = localStorage.getItem('repeatProps') === '1'; document.getElementById('repeat-props').checked = rpStored; document.getElementById('repeat-props').addEventListener('change', (e)=>{ localStorage.setItem('repeatProps', e.target.checked ? '1' : '0'); });
    const toggleManual = document.getElementById('toggle-manual-sub'); const manualWrap = document.getElementById('manual-sub-wrap'); toggleManual.addEventListener('change',()=>{ manualWrap.classList.toggle('hidden', !toggleManual.checked); });
    document.getElementById('project-load').addEventListener('change', loadProjectFromFile);
    document.getElementById('btn-logout').addEventListener('click', doLogout);
    document.getElementById('btn-auth').addEventListener('click', doLogin);
    $('#prop-preset').addEventListener('change', (e)=>{ if(e.target.value){ applyBrandPropertyPreset(parseInt(e.target.value)); e.target.value=''; } });
    
    document.addEventListener('keydown', (e)=>{ 
      if((e.ctrlKey || e.metaKey) && e.key === 'z'){
        e.preventDefault();
        performUndo();
        return;
      }
      if((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))){
        e.preventDefault();
        performRedo();
        return;
      }
      if(e.key==='F11' || e.key==='F11'){
        e.preventDefault();
        toggleFullScreen();
        return;
      }
      if(e.key==='Escape'){
        const activeModal = document.querySelector('.modal.active');
        if (activeModal) {
            activeModal.classList.remove('active');
        } else if (isDrawing || polyActive || currentTool === 'clone') {
            isDrawing = false;
            polyActive = false;
            polyPointsPx = [];
            cloneSource = null;
            setTool('select');
            draw();
        }
        alertMsg('All commands cancelled.');
        setTimeout(clearAlert, 2000);
      }
    });

    tryAutoLogin();
  });

  // Initialize copyright warning on page load
  document.addEventListener('DOMContentLoaded', () => {
    // Show copyright warning modal once per session
    const copyrightShown = sessionStorage.getItem('copyrightWarningShown');
    if (!copyrightShown) {
      setTimeout(() => {
        document.getElementById('copyright-warning-modal').classList.add('active');
        sessionStorage.setItem('copyrightWarningShown', 'true');
      }, 800);
    }
  });
  </script>
</body>
</html>
